<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tempat Curhat ðŸ’¬</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'fb-blue': '#1877F2',
            'fb-gray': '#F0F2F5',
            'fb-dark': '#3A3B3C',
            'fb-dark-bg': '#18191A',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* Mengatur body default agar sesuai dengan mode terang (light mode) */
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #F0F2F5; /* fb-gray */
      transition: background-color 0.3s;
      /* Memastikan body bisa digulir */
      min-height: 100vh;
      overflow-y: auto; 
    }

    /* Mengganti warna scrollbar untuk estetika */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* Input dan Button default styling (overridden by Tailwind classes) */
    input[type="text"], input[type="email"], input[type="password"], textarea { 
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus {
        outline: none;
        border-color: #1877F2;
        box-shadow: 0 0 0 1px #1877F2;
    }

    /* Styling khusus untuk modal agar tetap di tengah */
    #initialProfileModal, #locationModal { 
      display:none; 
      position:fixed; 
      inset:0; 
      align-items:center; 
      justify-content:center; 
    }
    #initialProfileModal {
        background: rgba(0,0,0,0.5); 
        z-index:1000;
    }
    #locationModal {
        /* Modal lokasi harus menutupi seluruh layar seperti aplikasi */
        background: #fff;
        display: none; 
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        z-index: 2000; /* Lebih tinggi dari postView */
    }

    /* KARTU POSTING (untuk konsistensi tampilan seperti gambar) */
    .post-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        margin-bottom: 12px;
    }

    /* Styling untuk Profile Picture di Feed */
    .profile-avatar-container {
        position: relative;
        cursor: pointer;
    }
    .profile-status-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background-color: #4CAF50; /* Green dot for status online */
        border-radius: 50%;
        border: 2px solid white;
    }
  </style>

  <script type="module">
    // --- KONFIGURASI FIREBASE SESUAI PERMINTAAN USER ---
    const firebaseConfig = {
      apiKey: "AIzaSyDqatY8EgkSDgOp799xdb1TqwdCwoda-7I",
      authDomain: "curhatan-959ee.firebaseapp.com",
      projectId: "curhatan-959ee",
      storageBucket: "curhatan-959ee.appspot.com",
      messagingSenderId: "111804283269",
      appId: "1:111804283269:web:da799747d37787f2ae6cec",
      measurementId: "G-4Q1V1J0800"
    };

    const appId = firebaseConfig.projectId; // Menggunakan projectId sebagai appId untuk path Firestore
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    // --- Firebase SDK (CDN versi 11.0.1) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, signInAnonymously, signInWithCustomToken } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion, setDoc, setLogLevel } 
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // setLogLevel('debug'); // Aktifkan ini untuk debugging

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Otentikasi awal menggunakan token atau anonim
    async function initializeAuth() {
        try {
            if (initialAuthToken) {
                // Catatan: Karena menggunakan konfigurasi custom, signInWithCustomToken mungkin memerlukan
                // setelan khusus di backend Firebase, namun kita coba gunakan.
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Gagal melakukan otentikasi awal. Pastikan konfigurasi Firebase sudah benar:", error);
            showModalMessage("Error Autentikasi", "Gagal menghubungkan ke server. Silakan coba muat ulang atau periksa koneksi internet.");
        }
    }

    // --- State Aplikasi ---
    let currentPage = 'Auth'; // Bisa 'Auth', 'Main', 'Post'
    let selectedLocation = null; // {name: "Nama Lokasi", detail: "Detail Lokasi"}
    let isAuthReady = false; // Status siap setelah onAuthStateChanged selesai
    
    // --- Data Lokasi Dummy ---
    const DUMMY_LOCATIONS = [
      { name: "Pantai Bahari Jeneponto", detail: "Jeneponto Â· Jeneponto, South Sulawesi" },
      { name: "Makassar", detail: "Kota Makassar, Sulawesi Selatan, ID" },
      { name: "Nasara, Sulawesi Selatan, Indonesia", detail: "Nasara, South Sulawesi, ID" },
      { name: "Bunia", detail: "Bunia, South Sulawesi, ID" },
      { name: "Zona Nyaman", detail: "Kota Makassar, Sulawesi Selatan, ID" },
      { name: "Kampung Beru Kec, bangkala Kab, jeneponto", detail: "Bangkala, South Sulawesi, ID" },
      { name: "Desa Laikang", detail: "Jeneponto, South Sulawesi, ID" },
    ];


    // --- DOM Elements ---
    const authView = document.getElementById("authView");
    const mainView = document.getElementById("mainView");
    const postView = document.getElementById("postView");
    const locationModal = document.getElementById("locationModal");
    const initialProfileModal = document.getElementById("initialProfileModal");
    const profileForm = document.getElementById("profileForm");
    const profileNameInput = document.getElementById("profileName");
    const curhatList = document.getElementById("curhatList");
    const userStatusDisplay = document.getElementById("userStatusDisplay");
    const postUsernameDisplay = document.getElementById("postUsernameDisplay");

    // --- Fungsi Navigasi Halaman ---
    function navigateTo(page) {
      currentPage = page;
      authView.style.display = 'none';
      mainView.style.display = 'none';
      postView.style.display = 'none';
      locationModal.style.display = 'none'; 
      initialProfileModal.style.display = 'none'; 
      
      if (page === 'Auth') {
        authView.style.display = 'flex'; // Menggunakan flex untuk centering
      } else if (page === 'Main') {
        mainView.style.display = 'block';
      } else if (page === 'Post') {
        postView.style.display = 'flex';
        renderLocationBar(); 
      }
    }

    // --- EVENT LISTENERS UI ---
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
    document.getElementById('goToPostBtn').addEventListener('click', () => {
        selectedLocation = null;
        navigateTo('Post');
    });
    document.getElementById('postFormBackBtn').addEventListener('click', () => navigateTo('Main'));
    document.getElementById('authSwitchToRegister').addEventListener('click', (e) => {
        e.preventDefault();
      document.getElementById('loginCard').classList.add('hidden');
      document.getElementById('registerCard').classList.remove('hidden');
    });
    document.getElementById('authSwitchToLogin').addEventListener('click', (e) => {
        e.preventDefault();
      document.getElementById('registerCard').classList.add('hidden');
      document.getElementById('loginCard').classList.remove('hidden');
    });

    // Buka Modal Lokasi
    document.getElementById('openLocationModalBtn').addEventListener('click', () => {
      renderLocationList(DUMMY_LOCATIONS);
      locationModal.style.display = 'flex';
    });

    // Tutup Modal Lokasi
    document.getElementById('locationModalBackBtn').addEventListener('click', () => {
      locationModal.style.display = 'none';
    });

    // Hapus Lokasi di Post View
    document.getElementById('removeLocationBtn').addEventListener('click', () => {
      selectedLocation = null;
      renderLocationBar();
    });

    // Filter Lokasi
    document.getElementById('locationSearchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = DUMMY_LOCATIONS.filter(loc => 
        loc.name.toLowerCase().includes(searchTerm) || 
        loc.detail.toLowerCase().includes(searchTerm)
      );
      renderLocationList(filtered);
    });

    // --- Fungsi Render dan Logika Lokasi ---

    // Menampilkan bar lokasi di bawah textarea posting
    function renderLocationBar() {
      if (selectedLocation) {
        document.getElementById('locationBarText').textContent = selectedLocation.name;
        document.getElementById('locationSelectionBar').classList.remove('hidden');
      } else {
        document.getElementById('locationSelectionBar').classList.add('hidden');
      }
    }

    // Menampilkan daftar lokasi di modal
    function renderLocationList(locations) {
      document.getElementById('locationList').innerHTML = '';
      if (locations.length === 0) {
        document.getElementById('locationList').innerHTML = `<p class="text-center text-gray-500 mt-4">Tidak ada lokasi ditemukan.</p>`;
        return;
      }
      locations.forEach(loc => {
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100';
        item.innerHTML = `
          <svg class="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          <div>
            <p class="font-semibold text-gray-900">${escapeHtml(loc.name)}</p>
            <p class="text-sm text-gray-500">${escapeHtml(loc.detail)}</p>
          </div>
        `;
        item.addEventListener('click', () => {
          selectedLocation = loc;
          locationModal.style.display = 'none';
          navigateTo('Post'); // Kembali ke post view
        });
        document.getElementById('locationList').appendChild(item);
      });
    }

    // --- Bagian Auth, Profile, dan Firestore ---
    
    document.getElementById('registerForm').addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        e.target.reset();
      } catch (err) {
        console.error("Gagal daftar:", err);
        showModalMessage("Gagal daftar", err.message);
      }
    });

    document.getElementById('loginForm').addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        e.target.reset();
      } catch (err) {
        console.error("Gagal login:", err);
        showModalMessage("Gagal masuk", err.message);
      }
    });

    async function saveProfileName(name) {
      const user = auth.currentUser;
      if (!user) return;
      await updateProfile(user, { displayName: name });
      // Path profile di Firestore disesuaikan: /artifacts/{projectId}/users/{userId}/profile/data
      const userDocRef = doc(db, "artifacts", appId, "users", user.uid, "profile", "data");
      await setDoc(userDocRef, {
        name,
        email: user.email,
        updatedAt: new Date()
      });
    }

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = profileNameInput.value.trim();
      if (!name) return showModalMessage("Perhatian", "Nama tidak boleh kosong");
      try {
        await saveProfileName(name);
        initialProfileModal.style.display = "none";
        // onAuthStateChanged akan menangani navigasi ke 'Main'
      } catch (err) {
        console.error("Gagal simpan nama:", err);
        showModalMessage("Gagal simpan nama", err.message);
      }
    });

    let unsubscribeCurhatListener = null;
    onAuthStateChanged(auth, async (user) => {
      isAuthReady = true; // Auth state sudah dicek
      
      // Hentikan listener lama jika ada
      if (unsubscribeCurhatListener) {
        unsubscribeCurhatListener();
        unsubscribeCurhatListener = null;
      }

      if (user) {
        const displayName = user.displayName || user.email;
        userStatusDisplay.textContent = displayName[0]; 
        document.getElementById('userStatusNameDisplay').textContent = displayName;
        postUsernameDisplay.textContent = displayName; 
        
        // Cek apakah display name sudah di set. Jika tidak, tampilkan modal nama.
        if (!user.displayName) {
          initialProfileModal.style.display = "flex";
          navigateTo('Auth'); 
          return;
        }

        initialProfileModal.style.display = "none";
        navigateTo('Main');

        // Path public untuk data yang bisa dilihat semua orang: /artifacts/{projectId}/public/data/curhatan
        unsubscribeCurhatListener = listenCurhatan();
      } else {
        document.getElementById('userStatusNameDisplay').textContent = "Guest";
        userStatusDisplay.textContent = "G";
        navigateTo('Auth');
      }
    });

    // Inisialisasi Auth saat script dimuat
    initializeAuth();

    // --- POST CURHATAN ---
    document.getElementById('curhatForm').addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = e.target.text.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user || !user.displayName) return showModalMessage("Kesalahan", "Harus login dan punya nama profil dulu.");
      const userName = user.displayName;
      
      const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "curhatan");

      const postData = {
        text,
        userId: user.uid,
        userName,
        createdAt: new Date(),
        comments: []
      };

      if (selectedLocation) {
          postData.location = selectedLocation;
      }

      try {
        await addDoc(postsCollectionRef, postData);
        e.target.reset();
        selectedLocation = null; 
        navigateTo('Main'); 
      } catch (err) {
        console.error("Gagal posting:", err);
        showModalMessage("Gagal posting", err.message);
      }
    });

    // --- LISTEN REAL-TIME CURHATAN ---
    function listenCurhatan() {
      if (!isAuthReady) return; // Pastikan auth sudah siap
      const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "curhatan");
      // Tidak menggunakan orderBy di query, sorting akan dilakukan di client
      const q = query(postsCollectionRef); 
      
      const unsub = onSnapshot(q, (snapshot) => {
        const curhatanData = [];
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            curhatanData.push({ id: docSnap.id, ...data });
        });

        // Sorting manual di client karena tidak menggunakan orderBy di query Firestore
        curhatanData.sort((a, b) => {
            // Mengurutkan berdasarkan timestamp. Jika ada yang null/undefined, tempatkan di akhir
            const timeA = a.createdAt ? a.createdAt.seconds : 0;
            const timeB = b.createdAt ? b.createdAt.seconds : 0;
            return timeB - timeA; // Descending
        });
        
        renderCurhatan(curhatanData);

      }, (err) => {
        console.error("Listen curhatan error:", err);
      });
      return unsub;
    }

    // Fungsi untuk merender daftar curhatan
    function renderCurhatan(curhatanData) {
        curhatList.innerHTML = "";
        
        if (curhatanData.length === 0) {
            curhatList.innerHTML = `
                <p class="text-center text-gray-500 mt-10 mb-4">Belum ada curhatan. Ayo buat postingan pertamamu!</p>
                ${generateDummyPosts()}
            `;
            curhatList.classList.add('pb-10');
            return;
        } else {
            curhatList.classList.remove('pb-10');
        }

        curhatanData.forEach((data) => {
            const id = data.id;

            const displayName = data.userName || data.user || "Anon";
            const time = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }) : 'Baru saja';
            const isOwnPost = auth.currentUser && data.userId === auth.currentUser.uid;
            
            const locationData = data.location;
            const locationDisplay = locationData 
                ? ` di <a href="#" class="font-bold text-fb-blue hover:underline">${escapeHtml(locationData.name)}</a>`
                : '';
                
            const mapPlaceholder = locationData 
                ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-xs font-semibold uppercase text-gray-500">${locationData.detail.split(' Â· ')[0]}</p>
                        <p class="text-lg font-extrabold text-gray-900">${escapeHtml(locationData.name)}</p>
                        <p class="text-sm text-gray-600 mt-1 flex items-center">
                            <svg class="w-4 h-4 mr-1 text-fb-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5a2 2 0 00-2-2h-3v5zM9 10a3 3 0 100-6 3 3 0 000 6zM10 19a1 1 0 00-1-1H6a1 1 0 00-1 1v1h5v-1z"></path></svg>
                            Anda dan 1 teman pernah ke sini (Dummy)
                        </p>
                    </div>
                ` : '';
                
            const div = document.createElement("div");
            div.className = "post-card mb-3 shadow-md"; 
            div.innerHTML = `
                <div class="p-4">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-lg mr-2">${displayName[0]}</div>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900">${escapeHtml(displayName)} 
                                ${locationDisplay}
                            </p>
                            <p class="text-xs text-gray-500">${time} Â· Publik</p>
                        </div>
                        ${isOwnPost ? '<div class="text-xs text-fb-blue">Anda</div>' : ''}
                    </div>

                    <p class="text-gray-800 text-lg my-3 whitespace-pre-wrap">${escapeHtml(data.text)}</p>
                    
                    ${mapPlaceholder}

                    <div class="flex justify-around border-t border-gray-200 mt-4 pt-2">
                        <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v5M6 10h2l3 3m-3 0v7a1 1 0 01-1 1H4a1 1 0 01-1-1v-7a1 1 0 011-1h2z"></path></svg>
                            Suka
                        </button>
                        <button class="comment-toggle flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 01-4.735-1.248l-3.376 1.099A.999.999 0 013 18.5V12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            Komentar (${(data.comments || []).length})
                        </button>
                        <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.024-3.535a6.66 6.66 0 000-4.634l-6.024-3.535M18 12a3 3 0 110-6 3 3 0 010 6zm0 0a3 3 0 110-6 3 3 0 010 6z"></path></svg>
                            Bagikan
                        </button>
                    </div>
                </div>

                <div class="comments-area border-t border-gray-100 p-4 bg-gray-50 hidden">
                    <div class="comments space-y-3 mb-4">
                    ${(data.comments || []).map(c => `
                        <div class="flex items-start">
                            <div class="w-7 h-7 rounded-full bg-gray-300 flex items-center justify-center text-xs font-semibold mr-2">${c.userName ? c.userName[0] : 'A'}</div>
                            <div class="bg-gray-200 p-2 rounded-xl flex-grow max-w-[calc(100%-40px)]">
                                <p class="font-semibold text-sm text-gray-800">${escapeHtml(c.userName || c.user)}</p>
                                <p class="text-sm text-gray-700 break-words">${escapeHtml(c.text)}</p>
                            </div>
                        </div>
                    `).join("")}
                    </div>
                    
                    <form class="commentForm flex gap-2 items-center" data-post-id="${id}">
                        <div class="w-8 h-8 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-sm">
                            ${auth.currentUser && auth.currentUser.displayName ? auth.currentUser.displayName[0] : 'A'}
                        </div>
                        <input type="text" placeholder="Tulis komentar..." required
                            class="flex-grow px-3 py-2 text-sm border-gray-300 bg-white rounded-full focus:ring-0 focus:border-fb-blue"
                        >
                        <button type="submit" class="text-fb-blue hover:opacity-75 transition duration-150 p-2 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m8 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </form>
                </div>
            `;
            
            const commentToggleBtn = div.querySelector(".comment-toggle");
            const commentsArea = div.querySelector(".comments-area");
            commentToggleBtn.addEventListener('click', () => {
                commentsArea.classList.toggle('hidden');
            });

            const form = div.querySelector(".commentForm");
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const commentInput = e.target.querySelector('input[type="text"]');
                const commentText = commentInput.value.trim();
                const postId = e.currentTarget.getAttribute('data-post-id');

                if (!commentText || !postId) return;
                const user = auth.currentUser;
                if (!user || !user.displayName) return showModalMessage("Kesalahan", "Harus login dulu untuk berkomentar!");
                
                const commenterName = user.displayName;
                const postRef = doc(db, "artifacts", appId, "public", "data", "curhatan", postId);

                try {
                    await updateDoc(postRef, {
                        comments: arrayUnion({ userId: user.uid, userName: commenterName, text: commentText })
                    });
                    e.target.reset();
                } catch (err) {
                    console.error("Gagal kirim komentar:", err);
                    showModalMessage("Gagal kirim komentar", err.message);
                }
            });

            curhatList.appendChild(div);
        });
    }


    // --- Helper: Generate Dummy Posts untuk Scrollable View ---
    function generateDummyPosts() {
        // Data Dummy untuk mengisi feed jika data kosong
        const dummyData = [
            { name: "Sistem", text: "Curhatanmu akan muncul di sini. Coba buat postingan pertamamu!", time: "Sekarang", location: { name: "Jeneponto", detail: "Sulawesi Selatan" } },
            { name: "Pengguna Anonim", text: "Halaman ini sudah bisa di-scroll ke bawah dan ke atas. Gulir terus untuk melihat postingan lama!", time: "1 jam lalu" },
            { name: "Admin", text: "Ini adalah postingan dummy untuk memastikan tampilan feed terlihat penuh dan fungsi scroll berjalan lancar.", time: "1 hari lalu" },
            { name: "Budi", text: "Semoga aplikasinya ramai ya! Saya senang dengan tampilan barunya. Sangat responsif di ponsel.", time: "2 hari lalu" },
            { name: "Dewi", text: "Hari ini cuaca cerah sekali, mood jadi bagus! âœ¨", time: "3 hari lalu", location: { name: "Makassar", detail: "Kota Angin Mamiri" } },
        ];

        return dummyData.map(data => {
            const locationDisplay = data.location 
              ? ` di <a href="#" class="font-bold text-fb-blue hover:underline">${data.location.name}</a>`
              : '';
            
            const mapPlaceholder = data.location 
              ? `
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-100 opacity-50">
                    <p class="text-xs font-semibold uppercase text-gray-500">${data.location.detail.split(' Â· ')[0]}</p>
                    <p class="text-lg font-extrabold text-gray-900">${escapeHtml(data.location.name)}</p>
                    <p class="text-sm text-gray-600 mt-1 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-fb-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5a2 2 0 00-2-2h-3v5zM9 10a3 3 0 100-6 3 3 0 000 6zM10 19a1 1 0 00-1-1H6a1 1 0 00-1 1v1h5v-1z"></path></svg>
                        Anda dan 1 teman pernah ke sini (Dummy)
                    </p>
                </div>
            ` : '';

            return `
                <div class="post-card mb-3 shadow-md opacity-80">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white font-bold text-lg mr-2">${data.name[0]}</div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-900">${data.name}
                                    ${locationDisplay}
                                </p>
                                <p class="text-xs text-gray-500">${data.time} Â· Dummy</p>
                            </div>
                        </div>
                        <p class="text-gray-800 text-lg my-3 whitespace-pre-wrap">${data.text}</p>
                        ${mapPlaceholder}
                        <div class="flex justify-around border-t border-gray-200 mt-4 pt-2 text-gray-400">
                            <button class="p-2">Suka</button>
                            <button class="p-2">Komentar</button>
                            <button class="p-2">Bagikan</button>
                        </div>
                    </div>
                </div>
            `;
        }).join("");
    }

    // --- Helper: escape untuk mencegah XSS sederhana ---
    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- Helper: Modal Pesan (Mengganti alert()) ---
    const msgModal = document.getElementById('messageModal');
    const msgTitle = document.getElementById('messageTitle');
    const msgContent = document.getElementById('messageContent');
    document.getElementById('messageCloseBtn').addEventListener('click', () => msgModal.style.display = 'none');
    
    function showModalMessage(title, content) {
        msgTitle.textContent = title;
        msgContent.textContent = content;
        msgModal.style.display = 'flex';
    }

  </script>
</head>

<body>
  
  
<!-- Modal Pesan Custom (Mengganti alert) -->
<div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[2000]">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-xs text-center">
          <h4 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">Pesan</h4>
          <p id="messageContent" class="text-gray-700 mb-4"></p>
          <button id="messageCloseBtn" class="bg-fb-blue hover:bg-opacity-80 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">Tutup</button>
      </div>
  </div>

  
<!-- Modal Pengaturan Nama Profil Awal -->
<div id="initialProfileModal" class="hidden">
    <div class="box bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
      <h3 class="text-2xl font-extrabold text-fb-blue mb-2">Selamat datang! ðŸ‘‹</h3>
      <p class="text-gray-600 mb-6">Tolong isi nama profil yang ingin kamu gunakan.</p>
      <form id="profileForm" class="space-y-4">
        <input id="profileName" type="text" placeholder="Nama yang mau ditampilkan" required 
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fb-blue focus:border-fb-blue"
        />
        <button type="submit" class="w-full bg-fb-blue hover:bg-opacity-80 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
          Simpan Nama
        </button>
      </form>
    </div>
  </div>


  
<!-- Halaman Login/Daftar -->
<div id="authView" class="hidden min-h-screen flex items-center justify-center bg-white p-4">
    <div class="w-full max-w-md">
      
      <!-- Logo App (FB Style) -->
      <div class="text-center mb-10">
        <svg class="mx-auto" fill="#1877F2" viewBox="0 0 24 24" width="48px" height="48px"><path d="M12 2C6.477 2 2 6.477 2 12c0 5.016 3.655 9.182 8.437 9.879V14.92h-2.92v-2.92h2.92V9.69c0-2.887 1.761-4.47 4.33-4.47.828 0 1.54.062 1.748.09V7.89h-1.571c-1.39 0-1.66.66-1.66 1.63V11.8h3.284l-.527 2.92h-2.757v6.959C18.345 21.182 22 17.016 22 12c0-5.523-4.477-10-10-10z"/></svg>
      </div>

      <!-- Kartu Login -->
      <div id="loginCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Masuk ke Tempat Curhat</h3>
        <form id="loginForm" class="space-y-4">
          <input type="email" name="email" placeholder="Email" required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue"
          >
          <input type="password" name="password" placeholder="Kata Sandi" required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue"
          >
          <button class="w-full bg-fb-blue hover:bg-opacity-90 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
            Login
          </button>
        </form>
        <p class="text-center mt-4 text-sm">
            <a href="#" class="text-fb-blue hover:underline">Lupa kata sandi?</a>
        </p>
        <div class="border-t border-gray-200 my-6"></div>
        <button id="authSwitchToRegister" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150">
          Buat Akun Baru
        </button>
      </div>
      
      <!-- Kartu Daftar -->
      <div id="registerCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hidden">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Daftar Akun Baru</h3>
        <form id="registerForm" class="space-y-4">
          <input type="email" name="email" placeholder="Email baru" required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue"
          >
          <input type="password" name="password" placeholder="Password baru" required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue"
          >
          <button class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
            Daftar
          </button>
        </form>
        <p class="text-center mt-4 text-sm">
            Sudah punya akun? <a href="#" id="authSwitchToLogin" class="text-fb-blue hover:underline">Login di sini</a>
        </p>
      </div>
    </div>
  </div>


  
<!-- Halaman Utama (Feed) -->
<div id="mainView" class="hidden pt-24 min-h-screen"> 
    
    <!-- Navigasi Atas (Fixed) -->
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-10">
      <div class="flex items-center justify-between max-w-xl mx-auto p-3">
        <h1 class="text-2xl font-extrabold text-fb-blue">CurhatApp</h1>
        <div class="flex items-center space-x-3">
            <!-- Tombol Logout -->
            <button id="logoutBtn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition duration-150">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            </button>
        </div>
      </div>
      
      <!-- Tab Navigasi -->
      <div class="flex justify-around border-t border-gray-200 text-gray-500">
        <div class="p-3 text-fb-blue border-b-2 border-fb-blue font-semibold">Feed Curhat</div>
        <div class="p-3 hover:bg-gray-100 transition duration-150">Notifikasi</div>
      </div>
    </nav>

    
    <!-- Konten Utama (Input Curhatan & Feed) -->
    <div class="max-w-xl mx-auto px-3 pt-3 pb-10"> 
        
        <!-- Kartu Input Curhatan -->
        <div class="bg-white p-3 rounded-xl shadow-md mb-4 border border-gray-100">
            <div class="flex items-center space-x-2">
                <div id="profileAvatarContainer" class="profile-avatar-container w-10 h-10">
                    <div class="w-full h-full rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-lg">
                        <span id="userStatusDisplay" class="font-semibold text-white">?</span>
                    </div>
                    <span class="profile-status-dot"></span>
                </div>
                <button id="goToPostBtn" class="flex-grow text-left bg-fb-gray p-2.5 rounded-full text-gray-600 hover:bg-gray-200 transition duration-150">
                    Apa yang Anda pikirkan?
                </button>
            </div>
            <div class="border-t border-gray-200 mt-3 pt-3 flex justify-around">
                <div class="flex items-center text-red-500 font-medium">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Foto/Video
                </div>
                <div class="flex items-center text-green-500 font-medium">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Perasaan
                </div>
            </div>
        </div>

        <!-- Daftar Curhatan (Feed) -->
        <div id="curhatList">
          <p class="text-center text-gray-500 mt-10">Memuat curhatan...</p>
        </div>
    </div>
  </div>


  
<!-- Halaman Buat Curhatan (Post View) -->
<div id="postView" class="hidden fixed inset-0 flex flex-col bg-white z-20">
    
    <!-- Header Post View -->
    <header class="flex items-center justify-between p-4 border-b border-gray-200 shadow-sm">
        <button id="postFormBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        </button>
        <h2 class="text-xl font-bold text-gray-900">Buat Curhatan</h2>
        <button id="submitPostBtn" form="curhatForm" class="bg-fb-blue hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:bg-gray-400">
            POSTING
        </button>
    </header>

    <!-- Area Input Postingan -->
    <div class="flex-grow p-4 overflow-y-auto">
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-xl mr-3">
                <span id="postUsernameDisplay" class="font-semibold text-white">?</span>
            </div>
            <div>
                <p class="font-semibold text-gray-900 text-lg">
                    <span id="postUsernameDisplay">Pengguna</span>
                </p>
                <div class="flex items-center text-sm text-gray-600 bg-gray-200 rounded-full px-3 py-1 mt-1">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0v4m-6 4h2m-2 4h2m6-4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-4a3 3 0 013-3h2.586a1 1 0 01.707.293l1.414 1.414A1 1 0 0012.414 14H18a2 2 0 002-2v-4a2 2 0 00-2-2h-3.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 009.586 6H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2v-1"></path></svg>
                    Publik
                </div>
            </div>
        </div>

        <form id="curhatForm" class="flex-grow flex flex-col">
            <textarea name="text" rows="10" placeholder="Apa yang Anda pikirkan?" required
              class="flex-grow text-xl p-0 border-none resize-none focus:ring-0 focus:border-transparent"
            ></textarea>
        </form>
        
    </div>

    <!-- Bar Lokasi yang Dipilih (Muncul jika ada lokasi) -->
    <div id="locationSelectionBar" class="hidden absolute bottom-20 left-4 right-4 bg-white p-3 rounded-xl shadow-lg border border-gray-200 flex items-center justify-between">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span id="locationBarText" class="font-semibold text-gray-800">Nama Lokasi</span>
        </div>
        <button id="removeLocationBtn" class="text-gray-500 hover:text-gray-700 p-1 rounded-full">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- Pilihan Tambahan Postingan (Lokasi, Foto, dll) -->
    <div class="border-t border-gray-200 p-4">
        <div class="space-y-4">
            <div class="flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150">
                <svg class="w-6 h-6 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Foto/Video
            </div>
            
            <button id="openLocationModalBtn" class="w-full flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150 text-left">
                <svg class="w-6 h-6 mr-3 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Tambahkan lokasi
            </button>

            <div class="flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150">
                <svg class="w-6 h-6 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Perasaan/aktivitas
            </div>
        </div>
    </div>
  </div>


  
<!-- Modal Pilihan Lokasi -->
<div id="locationModal" class="flex-col bg-white">
      <header class="flex items-center justify-between p-4 border-b border-gray-200">
          <button id="locationModalBackBtn" class="text-gray-700 hover:text-gray-900 p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Tambahkan Lokasi Anda</h2>
          <!-- Placeholder untuk tombol kanan (agar header seimbang) -->
          <button class="text-fb-blue font-semibold p-1 opacity-0 pointer-events-none">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          </button>
      </header>
      
      <!-- Search Bar Lokasi -->
      <div class="p-4 border-b border-gray-200">
          <div class="flex items-center bg-gray-100 rounded-full p-2">
              <input id="locationSearchInput" type="text" placeholder="Cari"
                  class="flex-grow bg-transparent border-none focus:ring-0 focus:border-transparent p-0 text-lg"
              />
              <svg class="w-6 h-6 text-gray-500 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
      </div>

      <!-- Daftar Lokasi -->
      <div class="flex-grow overflow-y-auto">
          <h3 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200">Saran</h3>
          <div id="locationList">
              <!-- Daftar Lokasi akan di-inject di sini oleh JavaScript -->
          </div>
      </div>
  </div>

</body>
</html>
