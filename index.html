<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tempat Curhat üí¨</title>

  

<script src="https://cdn.tailwindcss.com"></script>

  

<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'fb-blue': '#1877F2',
            'fb-gray': '#F0F2F5',
            'fb-dark': '#3A3B3C',
            'fb-dark-bg': '#18191A',
            'chat-sent': '#0084FF', 
            'chat-received': '#E4E6EB', 
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>

  

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* ... CSS default Anda ... */
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #F0F2F5;
      transition: background-color 0.3s;
      min-height: 100vh;
      overflow-y: auto; 
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    input[type="text"], input[type="email"], input[type="password"], textarea { 
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus {
        outline: none;
        border-color: #1877F2;
        box-shadow: 0 0 0 1px #1877F2;
    }
    #profileModal { 
      display:none; 
      position:fixed; 
      inset:0; 
      background: rgba(0,0,0,0.5); 
      align-items:center; 
      justify-content:center; 
      z-index:1000; 
    }
    
    /* (PERUBAHAN) Menambahkan profileView ke grup modal fullscreen */
    #locationModal, #feelingModal, #chatView, #menuView, #settingsView, #profileView {
        background: #fff;
        display: none; 
        position: fixed;
        inset: 0;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        z-index: 2000; 
    }
    
    #chatView, #menuView, #settingsView, #profileView {
        z-index: 3000; 
        background-color: #F0F2F5; /* Latar belakang abu-abu */
    }
    /* Khusus header modal, agar latar belakang putih */
    .modal-header {
        background-color: #FFFFFF;
    }
    /* (BARU) Tombol profil di feed */
    .profile-click-trigger {
        cursor: pointer;
    }

    .post-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        margin-bottom: 12px;
    }

    .feeling-tab.active {
        border-color: #1877F2;
        color: #1877F2;
    }

    /* ... CSS Chat Bubbles ... */
    #chatMessageList {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background-color: #FFFFFF; /* Latar belakang chat putih */
    }
    .chat-message-container { display: flex; flex-direction: column; }
    .chat-bubble { max-width: 70%; padding: 8px 12px; border-radius: 18px; word-wrap: break-word; font-size: 15px; line-height: 1.4; }
    .chat-sender-name { font-size: 12px; color: #65676B; margin-left: 12px; margin-bottom: 2px; }
    .chat-message-container.received { align-items: flex-start; }
    .chat-bubble.received { background-color: #E4E6EB; color: #050505; }
    .chat-message-container.sent { align-items: flex-end; }
    .chat-bubble.sent { background-color: #0084FF; color: white; }
  </style>

  <script type="module">
    // --- Variabel Global Canvas ---
    const firebaseConfig = {
      apiKey: "AIzaSyDqatY8EgkSDgOp799xdb1TqwdCwoda-7I",
      authDomain: "curhatan-959ee.firebaseapp.com",
      projectId: "curhatan-959ee",
      storageBucket: "curhatan-959ee.appspot.com",
      messagingSenderId: "111804283269",
      appId: "1:111804283269:web:da799747d37787f2ae6cec",
      measurementId: "G-4Q1V1J0800"
    };

    // --- Firebase SDK (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile }¬†
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    // (PERUBAHAN) Menambahkan getDoc, where, limitToLast
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion, setDoc, limitToLast, getDoc, where }¬†
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State Aplikasi ---
    let currentPage = 'Auth'; // Auth, Main, Post, Chat, Menu, Settings, Profile (BARU)
    let selectedLocation = null; 
    let selectedFeeling = null; 
    
    // --- Data Dummy ---
    // (Saya persingkat agar tidak terlalu panjang di contoh)
    const DUMMY_LOCATIONS = [
      { name: "Pantai Bahari Jeneponto", detail: "Jeneponto ¬∑ Jeneponto, South Sulawesi" },
    ];
    const DUMMY_FEELINGS = [
      { emoji: "üòä", text: "senang" }, { emoji: "üòá", text: "terberkati" },
    ];
    const DUMMY_ACTIVITIES = [
        { emoji: "üéâ", text: "merayakan..." }, { emoji: "‚úàÔ∏è", text: "bepergian ke..." },
    ];


    // --- DOM Elements ---
    const authView = document.getElementById("authView");
    const mainView = document.getElementById("mainView");
    const postView = document.getElementById("postView");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const curhatForm = document.getElementById("curhatForm");
    const curhatList = document.getElementById("curhatList");
    const userStatusDisplay = document.getElementById("userStatusDisplay");
    const profileModal = document.getElementById("profileModal");
    const profileForm = document.getElementById("profileForm");
    const profileNameInput = document.getElementById("profileName");
    const postFormBackBtn = document.getElementById("postFormBackBtn");
    const postAvatarLetter = document.getElementById("postAvatarLetter");
    const postUsernameText = document.getElementById("postUsernameText");
    
    // Elemen Lokasi
    const locationModal = document.getElementById("locationModal");
    const locationList = document.getElementById("locationList");
    const locationSearchInput = document.getElementById("locationSearchInput");
    const locationSelectionBar = document.getElementById("locationSelectionBar");
    const locationBarText = document.getElementById("locationBarText");

    // Elemen Perasaan
    const feelingModal = document.getElementById("feelingModal");
    const feelingList = document.getElementById("feelingList");
    const feelingSearchInput = document.getElementById("feelingSearchInput");
    const feelingTabPerasaan = document.getElementById("feelingTabPerasaan");
    const feelingTabAktivitas = document.getElementById("feelingTabAktivitas");

    // Elemen Chat Global
    const chatView = document.getElementById("chatView");
    const goToChatBtn = document.getElementById("goToChatBtn");
    const chatBackBtn = document.getElementById("chatBackBtn");
    const chatMessageList = document.getElementById("chatMessageList");
    const chatForm = document.getElementById("chatForm");
    const chatTextInput = document.getElementById("chatTextInput");

    // Elemen Menu & Pengaturan
    const menuView = document.getElementById("menuView");
    const settingsView = document.getElementById("settingsView");
    const openMenuBtn = document.getElementById("openMenuBtn");
    const menuBackBtn = document.getElementById("menuBackBtn");
    const menuProfileBtn = document.getElementById("menuProfileBtn"); // (BARU) Tombol profil di menu
    const menuSettingsBtn = document.getElementById("menuSettingsBtn");
    const menuLogoutBtn = document.getElementById("menuLogoutBtn");
    const menuProfileName = document.getElementById("menuProfileName");
    const settingsBackBtn = document.getElementById("settingsBackBtn");
    const settingsForm = document.getElementById("settingsForm");
    const settingsNameInput = document.getElementById("settingsNameInput");
    const settingsProfileName = document.getElementById("settingsProfileName");

    // (BARU) Elemen Halaman Profil
    const profileView = document.getElementById("profileView");
    const profileBackBtn = document.getElementById("profileBackBtn");
    const profileViewName = document.getElementById("profileViewName");
    const profileViewFriendCount = document.getElementById("profileViewFriendCount");
    const profileViewBio = document.getElementById("profileViewBio");
    const profileButtonContainer = document.getElementById("profileButtonContainer");
    const profilePostList = document.getElementById("profilePostList");


    // --- Fungsi Navigasi Halaman ---
    // (PERUBAHAN) Menambahkan 'data' untuk membawa info (cth: userId)
    async function navigateTo(page, data = null) {
      currentPage = page;
      authView.style.display = 'none';
      mainView.style.display = 'none';
      postView.style.display = 'none';
      locationModal.style.display = 'none'; 
      feelingModal.style.display = 'none'; 
      chatView.style.display = 'none';
      menuView.style.display = 'none'; 
      settingsView.style.display = 'none';
      profileView.style.display = 'none'; // (BARU)

      // (BARU) Hentikan listener postingan profil jika pindah halaman
      if (page !== 'Profile' && unsubscribeProfilePostsListener) {
          unsubscribeProfilePostsListener();
          unsubscribeProfilePostsListener = null;
      }

      if (page === 'Auth') {
        authView.style.display = 'block';
      } else if (page === 'Main') {
        mainView.style.display = 'block';
      } else if (page === 'Post') {
        postView.style.display = 'flex';
        renderLocationBar(); 
        renderPostHeader(); 
      } else if (page === 'Chat') { 
        chatView.style.display = 'flex';
      } else if (page === 'Menu') { 
        menuView.style.display = 'flex';
      } else if (page === 'Settings') { 
        settingsView.style.display = 'flex';
      } else if (page === 'Profile') { // (BARU)
        profileView.style.display = 'flex';
        if (data && data.userId) {
            await renderProfileView(data.userId); // Panggil render profil
        }
      }
    }

    // --- EVENT LISTENERS UI ---
    
    openMenuBtn.addEventListener('click', () => navigateTo('Menu')); 
    document.getElementById('goToPostBtn').addEventListener('click', () => {
        selectedLocation = null;
        selectedFeeling = null; 
        navigateTo('Post');
    });
    postFormBackBtn.addEventListener('click', () => navigateTo('Main'));
    document.getElementById('authSwitchToRegister').addEventListener('click', () => {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
    });
    document.getElementById('authSwitchToLogin').addEventListener('click', () => {
      document.getElementById('registerCard').style.display = 'none';
      document.getElementById('loginCard').style.display = 'block';
    });

    // Navigasi Chat
    goToChatBtn.addEventListener('click', () => navigateTo('Chat'));
    chatBackBtn.addEventListener('click', () => navigateTo('Main'));
    
    // Navigasi Menu & Pengaturan
    menuBackBtn.addEventListener('click', () => navigateTo('Main'));
    menuSettingsBtn.addEventListener('click', () => navigateTo('Settings'));
    menuLogoutBtn.addEventListener('click', () => signOut(auth)); 
    settingsBackBtn.addEventListener('click', () => navigateTo('Menu'));
    
    // (BARU) Tombol profil di Menu
    menuProfileBtn.addEventListener('click', () => {
        if (auth.currentUser) {
            navigateTo('Profile', { userId: auth.currentUser.uid });
        }
    });
    
    // (BARU) Tombol kembali di Halaman Profil
    profileBackBtn.addEventListener('click', () => navigateTo('Main'));


    // --- Event Listener Lokasi & Perasaan (Tidak Berubah) ---
    document.getElementById('openLocationModalBtn').addEventListener('click', () => {
      renderLocationList(DUMMY_LOCATIONS);
      locationModal.style.display = 'flex';
    });
    document.getElementById('locationModalBackBtn').addEventListener('click', () => locationModal.style.display = 'none');
    document.getElementById('removeLocationBtn').addEventListener('click', () => {
      selectedLocation = null;
      renderLocationBar();
    });
    locationSearchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = DUMMY_LOCATIONS.filter(loc => loc.name.toLowerCase().includes(searchTerm));
      renderLocationList(filtered);
    });
    document.getElementById('openFeelingModalBtn').addEventListener('click', () => {
      renderFeelingList(DUMMY_FEELINGS, 'feeling'); 
      feelingTabPerasaan.classList.add('active');
      feelingTabAktivitas.classList.remove('active');
      feelingSearchInput.value = '';
      feelingModal.style.display = 'flex';
    });
    document.getElementById('feelingModalBackBtn').addEventListener('click', () => feelingModal.style.display = 'none');
    feelingTabPerasaan.addEventListener('click', () => {
        renderFeelingList(DUMMY_FEELINGS, 'feeling');
        feelingTabPerasaan.classList.add('active');
        feelingTabAktivitas.classList.remove('active');
    });
    feelingTabAktivitas.addEventListener('click', () => {
        renderFeelingList(DUMMY_ACTIVITIES, 'activity');
        feelingTabPerasaan.classList.remove('active');
        feelingTabAktivitas.classList.add('active');
    });
    feelingSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const currentType = feelingTabPerasaan.classList.contains('active') ? 'feeling' : 'activity';
        const sourceData = currentType === 'feeling' ? DUMMY_FEELINGS : DUMMY_ACTIVITIES;
        const filtered = sourceData.filter(item => item.text.toLowerCase().includes(searchTerm));
        renderFeelingList(filtered, currentType);
    });
    function renderLocationBar() {
      if (selectedLocation) {
        locationBarText.textContent = selectedLocation.name;
        locationSelectionBar.classList.remove('hidden');
      } else {
        locationSelectionBar.classList.add('hidden');
      }
    }
    function renderLocationList(locations) {
      locationList.innerHTML = '';
      if (locations.length === 0) { /*...*/ return; }
      locations.forEach(loc => {
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100';
        item.innerHTML = `...`; // (Konten SVG disingkat)
        item.addEventListener('click', () => {
          selectedLocation = loc;
          locationModal.style.display = 'none';
          navigateTo('Post'); 
        });
        locationList.appendChild(item);
      });
    }
    function renderPostHeader() {
        const user = auth.currentUser;
        if (!user) return;
        const name = user.displayName || user.email;
        postAvatarLetter.textContent = name[0] || '?'; 
        let feelingHTML = '';
        if (selectedFeeling) {
            const actionText = selectedFeeling.type === 'feeling' ? 'merasa' : 'sedang';
            feelingHTML = ` ${escapeHtml(selectedFeeling.emoji)} <span class="font-normal">${actionText} ${escapeHtml(selectedFeeling.text)}.</span>`;
        }
        postUsernameText.innerHTML = `${escapeHtml(name)}${feelingHTML}`;
    }
    function renderFeelingList(items, type) {
        feelingList.innerHTML = '';
        if (items.length === 0) { /*...*/ return; }
        items.forEach(itemData => {
            const item = document.createElement('div');
            item.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100';
            item.innerHTML = `...`; // (Konten emoji disingkat)
            item.addEventListener('click', () => {
                selectedFeeling = { type: type, ...itemData };
                feelingModal.style.display = 'none';
                navigateTo('Post'); 
            });
            feelingList.appendChild(item);
        });
    }

    // --- (BARU) Fungsi Render Halaman Profil ---
    async function renderProfileView(userId) {
        const isOwnProfile = userId === auth.currentUser.uid;

        // 1. Ambil data pengguna dari koleksi 'users'
        let userName = "Pengguna";
        const userDocRef = doc(db, "users", userId);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
            userName = userDocSnap.data().name;
        }
        // (Catatan: bio dan teman masih placeholder)
        
        // 2. Set Info Profil
        profileViewName.textContent = `${userName} (Open)`;
        profileViewFriendCount.textContent = "151 teman"; // Placeholder
        profileViewBio.textContent = "Raised by havoc, crowned in fear\nthe name they whisper: sryn'x 2"; // Placeholder
        
        // 3. Set Tombol Dinamis
        profileButtonContainer.innerHTML = '';
        if (isOwnProfile) {
            // Tampilan Profil Sendiri
            profileButtonContainer.innerHTML = `
                <button class="flex-1 bg-fb-blue text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
                    Tambahkan ke cerita
                </button>
                <button class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>
                    Edit profil
                </button>
                <button class="bg-gray-200 text-gray-800 font-semibold py-2 px-3 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                </button>
            `;
        } else {
            // Tampilan Profil Orang Lain
            profileButtonContainer.innerHTML = `
                <button class="flex-1 bg-fb-blue text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                    Tambahkan jadi teman
                </button>
                <button class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"></path></svg>
                    Kirim pesan
                </button>
                <button class="bg-gray-200 text-gray-800 font-semibold py-2 px-3 rounded-lg">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                </button>
            `;
        }
        
        // 4. Muat Postingan Khusus Pengguna
        listenProfilePosts(userId);
    }


    // --- Bagian Auth, Profile ---
    
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        registerForm.reset();
      } catch (err) { console.error("Gagal daftar:", err); showModalMessage("Gagal daftar", err.message); }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        loginForm.reset();
      } catch (err) { console.error("Gagal login:", err); showModalMessage("Gagal login", err.message); }
    });

    // Fungsi update UI terpusat
    function updateProfileUI(user) {
        if (!user) return;
        const displayName = user.displayName || user.email;
        // 1. Main View (Header)
        userStatusDisplay.textContent = displayName; 
        // 2. Post View
        renderPostHeader();
        // 3. Menu View
        menuProfileName.textContent = displayName;
        // 4. Settings View
        settingsProfileName.textContent = displayName;
        settingsNameInput.value = displayName;
    }

    // Fungsi ini sekarang hanya menyimpan data
    async function saveProfileName(name) {
      const user = auth.currentUser;
      if (!user) return;
      await updateProfile(user, { displayName: name });
      // Simpan ke 'users' collection
      await setDoc(doc(db, "users", user.uid), {
        name,
        email: user.email,
        updatedAt: new Date()
      }, { merge: true }); // Gunakan merge jika ada data lain
    }

    // Form Pendaftaran Awal
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = profileNameInput.value.trim();
      if (!name) return showModalMessage("Perhatian", "Nama tidak boleh kosong");
      try {
        await saveProfileName(name);
        profileModal.style.display = "none";
        updateProfileUI(auth.currentUser); 
        navigateTo('Main');
      } catch (err) { console.error("Gagal simpan nama:", err); showModalMessage("Gagal simpan nama", err.message); }
    });
    
    // Form Pengaturan (Ganti nama)
    settingsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = settingsNameInput.value.trim();
        if (!name) return showModalMessage("Perhatian", "Nama tidak boleh kosong");
        try {
            await saveProfileName(name);
            updateProfileUI(auth.currentUser); 
            showModalMessage("Sukses", "Nama berhasil diperbarui!");
            navigateTo('Menu'); 
        } catch (err) { console.error("Gagal simpan nama:", err); showModalMessage("Gagal simpan nama", err.message); }
    });


    let unsubscribeCurhatListener = null;
    let unsubscribeChatListener = null; 
    let unsubscribeProfilePostsListener = null; // (BARU)

    onAuthStateChanged(auth, async (user) => {
      // Hentikan semua listener saat auth berubah
      if (unsubscribeCurhatListener) { unsubscribeCurhatListener(); unsubscribeCurhatListener = null; }
      if (unsubscribeChatListener) { unsubscribeChatListener(); unsubscribeChatListener = null; }
      if (unsubscribeProfilePostsListener) { unsubscribeProfilePostsListener(); unsubscribeProfilePostsListener = null; }

      if (user) {
        updateProfileUI(user); 
        
        if (!user.displayName) {
          profileModal.style.display = "flex";
          navigateTo('Auth'); 
          return;
        }

        profileModal.style.display = "none";
        navigateTo('Main');

        unsubscribeCurhatListener = listenCurhatan();
        unsubscribeChatListener = listenGlobalChat(); 
      } else {
        userStatusDisplay.textContent = "Guest";
        navigateTo('Auth');
      }
    });

    // --- POST CURHATAN (Firestore) ---
    curhatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = e.target.text.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return showModalMessage("Kesalahan", "Harus login dulu");
      const userName = user.displayName || user.email;
      const postData = {
        text, userId: user.uid, userName, createdAt: new Date(), comments: []
      };
      if (selectedLocation) { postData.location = selectedLocation; }
      if (selectedFeeling) { postData.feeling = selectedFeeling; }

      try {
        await addDoc(collection(db, "curhatan"), postData);
        curhatForm.reset();
        selectedLocation = null; 
        selectedFeeling = null; 
        navigateTo('Main'); 
      } catch (err) { console.error("Gagal posting:", err); showModalMessage("Gagal posting", err.message); }
    });

    // --- KIRIM PESAN CHAT GLOBAL (Firestore) ---
    chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = chatTextInput.value.trim();
        if (!text) return;
        const user = auth.currentUser;
        if (!user) return showModalMessage("Kesalahan", "Harus login dulu");
        const userName = user.displayName || user.email;
        const messageData = {
            text, userId: user.uid, userName, createdAt: new Date()
        };
        try {
            await addDoc(collection(db, "globalChat"), messageData);
            chatForm.reset();
            chatMessageList.scrollTop = chatMessageList.scrollHeight;
        } catch (err) { console.error("Gagal kirim pesan:", err); showModalMessage("Gagal kirim pesan", err.message); }
    });

    // --- (REFAKTOR) Fungsi Pembuat Elemen Postingan ---
    function createPostElement(id, data) {
        const displayName = data.userName || data.user || "Anon";
        const time = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }) : 'Baru saja';
        const isOwnPost = auth.currentUser && data.userId === auth.currentUser.uid;
        
        const locationData = data.location;
        const locationDisplay = locationData 
            ? ` di <a href="#" class="font-bold text-fb-blue hover:underline">${escapeHtml(locationData.name)}</a>`
            : '';
            
        const feelingData = data.feeling;
        let feelingDisplay = '';
        if (feelingData) {
            const actionText = feelingData.type === 'feeling' ? 'merasa' : 'sedang';
            feelingDisplay = ` ${escapeHtml(feelingData.emoji || '')} <span class="font-normal">${actionText} ${escapeHtml(feelingData.text)}.</span>`;
        }
            
        const mapPlaceholder = locationData ? `...` : ''; // (Konten map disingkat)
          
        const div = document.createElement("div");
        div.className = "post-card mb-3 shadow-md"; 
        div.innerHTML = `
          <div class="p-4">
              <div class="flex items-center mb-3">
                  <button class="flex items-center flex-grow profile-click-trigger text-left">
                      <div class="w-10 h-10 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-lg mr-2">${displayName[0]}</div>
                      <div class="flex-grow">
                          <p class="font-semibold text-gray-900">${escapeHtml(displayName)} 
                              ${feelingDisplay}
                              ${locationDisplay}
                          </p>
                          <p class="text-xs text-gray-500">${time} ¬∑ Publik</p>
                      </div>
                  </button>
                  ${isOwnPost ? '<div class="text-xs text-fb-blue">Anda</div>' : ''}
              </div>

              <p class="text-gray-800 text-lg my-3 whitespace-pre-wrap">${escapeHtml(data.text)}</p>
              
              ${mapPlaceholder}

              <div class="flex justify-around border-t border-gray-200 mt-4 pt-2">
                  <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path...></path></svg> Suka
                  </button>
                  <button class="comment-toggle flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path...></path></svg> Komentar (${(data.comments || []).length})
                  </button>
                  <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path...></path></svg> Bagikan
                  </button>
              </div>
          </div>

          <div class="comments-area border-t border-gray-100 p-4 bg-gray-50 hidden">
              <div class="comments space-y-3 mb-4">
                ${(data.comments || []).map(c => `...`).join("")} </div>
              <form class="commentForm flex gap-2 items-center">
                  <div class="w-8 h-8 rounded-full bg-fb-blue ...">
                      ${auth.currentUser ? auth.currentUser.displayName[0] : 'A'}
                  </div>
                  <input type="text" placeholder="Tulis komentar..." required class="flex-grow ...">
                  <button class="text-fb-blue ...">
                      <svg class="w-5 h-5" ...><path...></path></svg>
                  </button>
              </form>
          </div>
        `;
        
        // (BARU) Event listener untuk klik profil
        const profileTrigger = div.querySelector(".profile-click-trigger");
        profileTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('Profile', { userId: data.userId });
        });
        
        // Event listener untuk Komentar
        const commentToggleBtn = div.querySelector(".comment-toggle");
        const commentsArea = div.querySelector(".comments-area");
        commentToggleBtn.addEventListener('click', () => {
          commentsArea.classList.toggle('hidden');
        });

        // Event listener Form Komentar
        const form = div.querySelector(".commentForm");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          // ... (Logika kirim komentar tidak berubah)
          const commentInput = e.target.querySelector('input[type="text"]');
          const commentText = commentInput.value.trim();
          if (!commentText) return;
          const user = auth.currentUser;
          if (!user) return showModalMessage("Kesalahan", "Harus login dulu untuk berkomentar!");
          const commenterName = user.displayName || user.email;
          try {
            await updateDoc(doc(db, "curhatan", id), {
              comments: arrayUnion({ userId: user.uid, userName: commenterName, text: commentText })
            });
            e.target.reset();
          } catch (err) { console.error("Gagal kirim komentar:", err); showModalMessage("Gagal kirim komentar", err.message); }
        });
        
        return div; // Kembalikan elemen DOM
    }


    // --- LISTEN REAL-TIME CURHATAN ---
    function listenCurhatan() {
      const q = query(collection(db, "curhatan"), orderBy("createdAt", "desc"));
      const unsub = onSnapshot(q, (snapshot) => {
        curhatList.innerHTML = "";
        
        if (snapshot.empty) {
             curhatList.innerHTML = `
                <p class="text-center text-gray-500 mt-10 mb-4">Belum ada curhatan. Ayo buat postingan pertamamu!</p>
                ${generateDummyPosts()}
            `;
            curhatList.classList.add('pb-10');
            return;
        } else {
            curhatList.classList.remove('pb-10');
        }
        
        // (REFAKTOR) Menggunakan fungsi createPostElement
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          const postElement = createPostElement(id, data);
          curhatList.appendChild(postElement);
        });
      }, (err) => {
        console.error("Listen curhatan error:", err);
      });
      return unsub;
    }
    
    // --- (BARU) LISTEN REAL-TIME POSTINGAN PROFIL ---
    function listenProfilePosts(userId) {
        // Hentikan listener lama jika ada
        if (unsubscribeProfilePostsListener) {
            unsubscribeProfilePostsListener();
        }

        profilePostList.innerHTML = "<p class='text-center p-4'>Memuat postingan...</p>";
        
        // Buat query baru dengan filter 'where'
        const q = query(
            collection(db, "curhatan"),
            where("userId", "==", userId), // <-- KUNCI FILTER
            orderBy("createdAt", "desc")
        );
        
        unsubscribeProfilePostsListener = onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                profilePostList.innerHTML = "<p class='text-center p-4'>Pengguna ini belum memiliki postingan.</p>";
                return;
            }
            
            profilePostList.innerHTML = ""; // Bersihkan
            
            // (REFAKTOR) Menggunakan fungsi createPostElement
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                const postElement = createPostElement(id, data);
                profilePostList.appendChild(postElement);
            });
        }, (err) => {
            console.error("Listen profile posts error:", err);
            profilePostList.innerHTML = "<p class='text-center p-4 text-red-500'>Gagal memuat postingan.</p>";
        });
    }


    // --- LISTEN REAL-TIME CHAT GLOBAL ---
    function listenGlobalChat() {
        const q = query(collection(db, "globalChat"), orderBy("createdAt", "asc"), limitToLast(50));
        const unsub = onSnapshot(q, (snapshot) => {
            chatMessageList.innerHTML = ""; 
            if (snapshot.empty) {
                chatMessageList.innerHTML = `<p class="text-center text-gray-500 mt-4">Belum ada pesan. Mulai obrolan!</p>`;
                return;
            }
            snapshot.forEach((doc) => {
                const data = doc.data();
                const isOwnMessage = auth.currentUser && data.userId === auth.currentUser.uid;
                const container = document.createElement('div');
                container.className = 'chat-message-container';
                if (isOwnMessage) {
                    container.classList.add('sent');
                    container.innerHTML = `<div class="chat-bubble sent">${escapeHtml(data.text)}</div>`;
                } else {
                    container.classList.add('received');
                    container.innerHTML = `
                        <p class="chat-sender-name">${escapeHtml(data.userName)}</p>
                        <div class="chat-bubble received">${escapeHtml(data.text)}</div>
                    `;
                }
                chatMessageList.appendChild(container);
            });
            chatMessageList.scrollTop = chatMessageList.scrollHeight;
        }, (err) => { console.error("Listen chat error:", err); });
        return unsub;
    }


    // --- Helper: Generate Dummy Posts ---
    function generateDummyPosts() {
        // ... (Fungsi ini tidak berubah)
        return `...`;
    }

    // --- Helper: escape ---
    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    // --- Helper: Modal Pesan ---
    const msgModal = document.getElementById('messageModal');
    const msgTitle = document.getElementById('messageTitle');
    const msgContent = document.getElementById('messageContent');
    document.getElementById('messageCloseBtn').addEventListener('click', () => msgModal.style.display = 'none');
    function showModalMessage(title, content) {
        msgTitle.textContent = title;
        msgContent.textContent = content;
        msgModal.style.display = 'flex';
    }

  </script>
</head>

<body>
  
  

<div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[5000]">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-xs text-center">
          <h4 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">Pesan</h4>
          <p id="messageContent" class="text-gray-700 mb-4"></p>
          <button id="messageCloseBtn" class="bg-fb-blue hover:bg-opacity-80 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">Tutup</button>
      </div>
  </div>

  

<div id="profileModal" class="hidden">
    <div class="box bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
      <h3 class="text-2xl font-extrabold text-fb-blue mb-2">Selamat datang! üëã</h3>
      <p class="text-gray-600 mb-6">Tolong isi nama profil yang ingin kamu gunakan.</p>
      <form id="profileForm" class="space-y-4">
        <input id="profileName" type="text" placeholder="Nama yang mau ditampilkan" required 
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fb-blue focus:border-fb-blue"
        />
        <button type="submit" class="w-full bg-fb-blue hover:bg-opacity-80 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
          Simpan Nama
        </button>
      </form>
    </div>
  </div>


  

<div id="authView" class="hidden min-h-screen flex items-center justify-center bg-white p-4">
    <div class="w-full max-w-md">...</div>
</div>


  

<div id="mainView" class="hidden pt-24 min-h-screen"> 
    
<nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-10">
      <div class="flex items-center justify-between max-w-xl mx-auto p-3">
        <h1 class="text-2xl font-extrabold text-fb-blue">CurhatApp</h1>
        <div class="flex items-center space-x-3">
            <button id="openMenuBtn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition duration-150">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
            </button>
        </div>
      </div>
      <div class="flex justify-around border-t border-gray-200 text-gray-500">
        <div class="p-3 text-fb-blue border-b-2 border-fb-blue font-semibold w-full text-center">Feed Curhat</div>
        <button id="goToChatBtn" class="p-3 hover:bg-gray-100 transition duration-150 w-full text-center">Pesan Global</button>
      </div>
    </nav>

<div class="max-w-xl mx-auto px-3 pt-3 pb-10"> 
<div class="bg-white p-3 rounded-xl shadow-md mb-4 border border-gray-100">
            </div>
<div id="curhatList">
          <p class="text-center text-gray-500 mt-10">Memuat curhatan...</p>
        </div>
    </div>
  </div>


  

<div id="postView" class="hidden fixed inset-0 flex flex-col bg-white z-20">
    <header class="modal-header ...">...</header>
    <div class="flex-grow p-4 overflow-y-auto bg-white">...</div>
    <div id="locationSelectionBar" class="hidden ...">...</div>
    <div class="border-t border-gray-200 p-4 bg-white">...</div>
</div>


  

<div id="locationModal" class="flex-col">
    </div>

  

<div id="feelingModal" class="flex-col">
    </div>


  

<div id="chatView" class="hidden"> 
    <header class="modal-header ...">...</header>
    <div id="chatMessageList" class="flex-grow overflow-y-auto"></div>
    <footer class="p-3 border-t border-gray-200 bg-white">...</footer>
</div>


  

<div id="menuView" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="menuBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Menu</h2>
          <div class="w-6"></div>
      </header>

      <div class="flex-grow overflow-y-auto p-4">
          <button id="menuProfileBtn" class="w-full bg-white p-4 rounded-lg shadow-md mb-4 flex items-center text-left hover:bg-gray-50 transition duration-150">
              <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-xl font-bold text-gray-700 mr-4">
                  </div>
              <div>
                  <h3 id="menuProfileName" class="text-xl font-bold text-gray-900">Nama Pengguna</h3>
                  <p class="text-sm text-gray-600">Lihat profil Anda</p>
              </div>
          </button>
          
          <button id="menuSettingsBtn" class="w-full flex items-center bg-white p-4 rounded-lg shadow-md mb-4 text-left hover:bg-gray-50 transition duration-150">
              <div class="p-2 bg-gray-200 rounded-full mr-4">
                  <svg class="w-6 h-6 text-gray-700" ...><path...></path></svg>
              </div>
              <p class="text-lg font-semibold text-gray-800">Pengaturan</an>
          </button>
          
          <button id="menuLogoutBtn" class="w-full flex items-center bg-white p-4 rounded-lg shadow-md text-left hover:bg-gray-50 transition duration-150">
              <div class="p-2 bg-gray-200 rounded-full mr-4">
                  <svg class="w-6 h-6 text-gray-700" ...><path...></path></svg>
              </div>
              <p class="text-lg font-semibold text-gray-800">Keluar</p>
          </button>
      </div>
  </div>


  

<div id="settingsView" class="hidden"> 
    <header class="modal-header ...">...</header>
    <div class="flex-grow overflow-y-auto p-4">...</div>
</div>


  <div id="profileView" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="profileBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Profil</h2>
          <button class="text-gray-700 hover:text-fb-blue p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </button>
      </header>

      <div class="flex-grow overflow-y-auto">
          <div class="relative bg-gray-700 h-40">
              <div class="absolute -bottom-12 left-4 w-24 h-24 rounded-full bg-gray-300 border-4 border-white">
                  </div>
          </div>
          
          <div class="p-4 mt-12 bg-white border-b border-gray-200">
              <h3 id="profileViewName" class="text-2xl font-bold text-gray-900">Nama Pengguna (Open)</h3>
              <p id="profileViewFriendCount" class="text-gray-600 font-semibold">151 teman</p>
              <p id="profileViewBio" class="text-gray-800 my-2 whitespace-pre-wrap">Bio pengguna...</p>
              
              <div id="profileButtonContainer" class="flex items-center gap-2 mt-4">
                  </div>
          </div>

          <div class="flex justify-around bg-white border-b border-gray-200 text-gray-600 font-semibold">
              <div class="p-4 text-fb-blue border-b-2 border-fb-blue">Postingan</div>
              <div class="p-4">Foto</div>
              <div class="p-4">Reels</div>
          </div>
          
          <div class="p-4 bg-white mt-3">
              <h4 class="text-xl font-bold mb-2">Intro</h4>
              <div class="space-y-3 text-gray-700">
                  <p>üèôÔ∏è Tinggal di Kota Saat Ini</p>
                  <p>üíº Bekerja di Kantor</p>
                  <p>üéì Belajar di Sekolah</p>
                  <p>üè† Dari Kota Asal</p>
              </div>
          </div>

          <div id="profilePostList" class="mt-3">
              <p class="text-center p-4">Memuat postingan...</p>
          </div>
      </div>
  </div>

</body>
</html>