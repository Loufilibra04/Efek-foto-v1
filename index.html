<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Konexa App üí¨</title>

  

<script src="https://cdn.tailwindcss.com"></script>

  

<script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'fb-blue': '#1877F2',
            'fb-gray': '#F0F2F5',
            'fb-dark': '#3A3B3C',
            'fb-dark-bg': '#18191A',
            'chat-sent': '#0084FF', 
            'chat-received': '#E4E6EB', 
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>

  

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* Mengatur body default agar sesuai dengan mode terang (light mode) */
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #F0F2F5; /* fb-gray */
      transition: background-color 0.3s;
      /* Memastikan body bisa digulir */
      min-height: 100vh;
      overflow-y: auto; 
    }

    /* Mengganti warna scrollbar untuk estetika */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* Input dan Button default styling (overridden by Tailwind classes) */
    input[type="text"], input[type="email"], input[type="password"], textarea { 
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        width: 100%;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus {
        outline: none;
        border-color: #1877F2;
        box-shadow: 0 0 0 1px #1877F2;
    }

    /* Styling khusus untuk modal agar tetap di tengah */
    #profileModal { 
      display:none; 
      position:fixed; 
      inset:0; 
      background: rgba(0,0,0,0.5); 
      align-items:center; 
      justify-content:center; 
      z-index:1000; 
    }
    
    /* Modal fullscreen */
    #locationModal, #feelingModal, #chatView, #menuView, #settingsView, #avatarModal, #chatSettingsModal {
        background: #fff;
        display: none; 
        position: fixed;
        inset: 0;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        z-index: 1000; 
    }
    
    #chatView, #menuView, #settingsView, #avatarModal, #chatSettingsModal {
        z-index: 3000; 
        background-color: #F0F2F5; /* Latar belakang abu-abu */
    }
    /* Khusus header modal, agar latar belakang putih */
    .modal-header {
        background-color: #FFFFFF;
    }

    /* KARTU POSTING (untuk konsistensi tampilan seperti gambar) */
    .post-card {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        margin-bottom: 10px;
    }

    /* Styling Tab untuk Modal Perasaan */
    .feeling-tab.active {
        border-color: #1877F2; /* fb-blue */
        color: #1877F2;
    }

    /* --- CSS Chat Bubbles --- */
    #chatMessageList {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        /* background-color: #FFFFFF; <-- DIHAPUS, diatur oleh JS */
        transition: background-color 0.3s;
    }
    .chat-message-container { display: flex; flex-direction: column; }
    .chat-bubble { max-width: 70%; padding: 8px 12px; border-radius: 18px; word-wrap: break-word; font-size: 15px; line-height: 1.4; }
    .chat-sender-name { font-size: 12px; color: #65676B; margin-left: 12px; margin-bottom: 2px; }
    .chat-message-container.received { align-items: flex-start; }
    .chat-bubble.received { background-color: #E4E6EB; color: #050505; }
    .chat-message-container.sent { align-items: flex-end; }
    .chat-bubble.sent { background-color: #0084FF; color: white; }
    
    /* Scrollbar horizontal untuk background */
    #backgroundSelectorContainer::-webkit-scrollbar {
        height: 4px;
    }
    #backgroundSelectorContainer::-webkit-scrollbar-thumb {
        background: #ccc;
    }
    
    /* Styling untuk text area dengan background */
    textarea.with-background {
        background-size: cover;
        background-position: center;
    }
    textarea.with-background::placeholder {
        color: #ffffffaa; /* Placeholder warna putih transparan */
    }
    
    /* Styling untuk avatar SVG */
    .avatar-icon {
        width: 60%;
        height: 60%;
    }
    .avatar-icon-sm {
        width: 60%;
        height: 60%;
    }
    .avatar-icon-lg {
        width: 60%;
        height: 60%;
    }
  </style>

  <script type="module">
    // --- Variabel Global Canvas ---
    const firebaseConfig = {
      apiKey: "AIzaSyDqatY8EgkSDgOp799xdb1TqwdCwoda-7I",
      authDomain: "curhatan-959ee.firebaseapp.com",
      projectId: "curhatan-959ee",
      storageBucket: "curhatan-959ee.appspot.com",
      messagingSenderId: "111804283269",
      appId: "1:111804283269:web:da799747d37787f2ae6cec",
      measurementId: "G-4Q1V1J0800"
    };

    // --- Firebase SDK (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile }¬†
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, arrayUnion, setDoc, limitToLast, getDoc }¬†
      from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State Aplikasi ---
    let currentPage = 'Auth'; // Auth, Main, Post, Chat, Menu, Settings
    let selectedLocation = null; 
    let selectedFeeling = null; 
    let selectedBackground = null; 
    let currentUserAvatarId = null; 
    let userDocUnsubscribe = null; 
    let selectedChatThemeId = 'default'; // State untuk tema chat

    // --- Data Dummy ---
    const DUMMY_LOCATIONS = [
      { name: "Pantai Bahari Jeneponto", detail: "Jeneponto ¬∑ Jeneponto, South Sulawesi" },
    ];
    const DUMMY_FEELINGS = [
      { emoji: "üòä", text: "senang" }, { emoji: "üòá", text: "terberkati" },
    ];
    const DUMMY_ACTIVITIES = [
        { emoji: "üéâ", text: "merayakan..." }, { emoji: "‚úàÔ∏è", text: "bepergian ke..." },
    ];
    
    const DUMMY_BACKGROUNDS = [
        { id: 'default', css: 'bg-white', textStyle: 'text-xl text-gray-800' }, 
        { id: 'pink-grad', css: 'bg-gradient-to-br from-pink-500 to-fuchsia-600', textStyle: 'text-3xl text-white font-bold' },
        { id: 'purple-grad', css: 'bg-gradient-to-tr from-purple-600 to-indigo-800', textStyle: 'text-3xl text-white font-bold' },
        { id: 'orange-grad', css: 'bg-gradient-to-br from-yellow-400 via-red-500 to-pink-600', textStyle: 'text-3xl text-white font-bold' },
        { id: 'green-grad', css: 'bg-gradient-to-br from-green-400 to-blue-500', textStyle: 'text-3xl text-white font-bold' },
        { id: 'black-solid', css: 'bg-gray-900', textStyle: 'text-3xl text-white font-bold' },
        { id: 'red-solid', css: 'bg-red-600', textStyle: 'text-3xl text-white font-bold' },
    ];
    
    const DUMMY_AVATARS = [
        { id: 'ghost', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10s10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8s8 3.589 8 8s-3.589 8-8 8z"></path><path d="M12 17c2.757 0 5-2.243 5-5s-2.243-5-5-5s-5 2.243-5 5s2.243 5 5 5zm0-8c1.654 0 3 1.346 3 3s-1.346 3-3 3s-3-1.346-3-3s1.346-3 3-3z"></path><circle cx="8.5" cy="10.5" r="1.5"></circle><circle cx="15.5" cy="10.5" r="1.5"></circle></svg>` },
        { id: 'heart', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>` },
        { id: 'star', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>` },
        { id: 'fire', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M13.4 2.09c-.21-.06-.42-.09-.65-.09-2.19 0-3.98 1.6-4.42 3.66C6.1 7.23 5 9.97 5 13c0 3.87 3.13 7 7 7s7-3.13 7-7c0-3.03-1.1-5.77-3.35-7.34C15.15 4.1 14.18 2.8 13.4 2.09zM12 18c-2.76 0-5-2.24-5-5 0-2.34 1.25-4.4 3.08-5.45l.42-.24.16-.45C11.12 5.5 11.54 4 12.95 4c.64 0 1.15.52 1.15 1.15 0 .28-.11.55-.3.76l-.44.51-.23.47c-1.83 2.1-2.13 4.95-1.12 7.37.64 1.54 2.08 2.74 3.85 2.74 1.09 0 2.08-.43 2.84-1.13C17.43 16.7 15.1 18 12 18z"></path></svg>` },
        { id: 'leaf', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1.92 14.65c-.48-.09-.88-.41-1.04-.84l-2.03-5.21c-.13-.33-.03-.7.24-.97.27-.27.64-.37.97-.24l5.21 2.03c.43.17.75.56.84 1.04.09.48.01 1.03-.23 1.48-.25.45-.66.86-1.11 1.11-.45.24-1 .32-1.48.23zm3.5-2.23l-3.99-1.55 1.55 3.99c.1.26.02.56-.19.77-.21.21-.51.29-.77.19l-3.99-1.55c-.26-.1-.48-.32-.57-.59-.09-.26-.06-.54.08-.78l.01-.01 5.08-5.08.01-.01c.24-.14.52-.17.78-.08.27.09.49.31.59.57l1.55 3.99c.1.26.02.56-.19.77-.21.21-.51.29-.77.19z"></path></svg>` },
        { id: 'planet', svg: `<svg class="avatar-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm6.27 12.57c-.43.51-1.03.85-1.7.99-1.28.27-2.61.12-3.8-.4-1.19-.52-2.22-1.32-3-2.31-.78-.99-1.29-2.18-1.45-3.43-.16-1.25.1-2.52.74-3.6.43-.72 1.04-1.32 1.77-1.71.73-.39 1.54-.6 2.37-.58 1.28.03 2.53.5 3.53 1.34.42.35.8.76 1.13 1.22.33.46.59.97.77 1.5.18.53.28 1.08.28 1.63s-.1 1.1-.28 1.63c-.18.53-.44 1.04-.77 1.5-.33.46-.71.87-1.13 1.22z"></path><path d="M15.42 16.5c-1.39.56-2.9.7-4.42.37-1.52-.33-2.9-1.1-3.96-2.22-.3-.31-.57-.65-.82-.99-.08-.11-.16-.22-.23-.34-.14-.23-.27-.47-.39-.71-.24-.5-.43-1.02-.56-1.55-.13-.53-.19-1.08-.19-1.62 0-.54.06-1.09.19-1.62.13-.53.32-1.05.56-1.55.12-.24.25-.48.39-.71.07-.12.15-.23.23-.34.25-.34.52-.68.82-.99 1.06-1.12 2.44-1.89 3.96-2.22 1.52-.33 3.03-.2 4.42.37 1.39.56 2.6 1.51 3.47 2.73.18.25.35.51.5.78.29.53.53 1.09.69 1.67.16.58.24 1.18.24 1.79s-.08 1.21-.24 1.79c-.16.58-.4 1.14-.69 1.67-.15.27-.32.53-.5.78-.87 1.22-2.08 2.17-3.47 2.73z"></path></svg>` }
    ];
    
    // Data Tema Chat
    const DUMMY_CHAT_THEMES = [
        { id: 'default', name: 'Default', css: 'bg-white' },
        { id: 'dark', name: 'Dark', css: 'bg-gray-800' },
        { id: 'ocean', name: 'Ocean', css: 'bg-gradient-to-br from-blue-100 to-cyan-100' },
        { id: 'sunset', name: 'Sunset', css: 'bg-gradient-to-br from-yellow-100 via-pink-100 to-red-100' },
        { id: 'forest', name: 'Forest', css: 'bg-gradient-to-br from-green-200 to-lime-300' },
    ];


    // --- DOM Elements ---
    const authView = document.getElementById("authView");
    const mainView = document.getElementById("mainView");
    const postView = document.getElementById("postView");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const curhatForm = document.getElementById("curhatForm");
    const curhatList = document.getElementById("curhatList");
    const userStatusDisplay = document.getElementById("userStatusDisplay");
    const profileModal = document.getElementById("profileModal");
    const profileForm = document.getElementById("profileForm");
    const profileNameInput = document.getElementById("profileName");
    const postFormBackBtn = document.getElementById("postFormBackBtn");
    const postAvatarLetter = document.getElementById("postAvatarLetter");
    const postUsernameText = document.getElementById("postUsernameText");
    const postUserAvatarBlock = document.getElementById('postUserAvatarBlock'); 
    
    // Elemen Lokasi
    const locationModal = document.getElementById("locationModal");
    const locationList = document.getElementById("locationList");
    const locationSearchInput = document.getElementById("locationSearchInput");
    const locationSelectionBar = document.getElementById("locationSelectionBar");
    const locationBarText = document.getElementById("locationBarText");

    // Elemen Perasaan
    const feelingModal = document.getElementById("feelingModal");
    const feelingList = document.getElementById("feelingList");
    const feelingSearchInput = document.getElementById("feelingSearchInput");
    const feelingTabPerasaan = document.getElementById("feelingTabPerasaan");
    const feelingTabAktivitas = document.getElementById("feelingTabAktivitas");

    // Elemen Chat Global
    const chatView = document.getElementById("chatView");
    const goToChatBtn = document.getElementById("goToChatBtn");
    const chatBackBtn = document.getElementById("chatBackBtn");
    const chatMessageList = document.getElementById("chatMessageList");
    const chatForm = document.getElementById("chatForm");
    const chatTextInput = document.getElementById("chatTextInput");
    const chatSettingsBtn = document.getElementById('chatSettingsBtn'); // Tombol setting di chat

    // Elemen Menu & Pengaturan
    const menuView = document.getElementById("menuView");
    const settingsView = document.getElementById("settingsView");
    const openMenuBtn = document.getElementById("openMenuBtn");
    const menuBackBtn = document.getElementById("menuBackBtn");
    const menuSettingsBtn = document.getElementById("menuSettingsBtn");
    const menuLogoutBtn = document.getElementById("menuLogoutBtn");
    const menuProfileName = document.getElementById("menuProfileName");
    const settingsBackBtn = document.getElementById("settingsBackBtn");
    const settingsForm = document.getElementById("settingsForm");
    const settingsNameInput = document.getElementById("settingsNameInput");
    const settingsProfileName = document.getElementById("settingsProfileName");
    
    // Elemen Background
    const backgroundSelectorContainer = document.getElementById('backgroundSelectorContainer');
    
    // Elemen Avatar
    const avatarModal = document.getElementById('avatarModal');
    const avatarList = document.getElementById('avatarList');
    const avatarModalBackBtn = document.getElementById('avatarModalBackBtn');
    const openAvatarModalBtn = document.getElementById('openAvatarModalBtn');
    
    // Elemen Pengaturan Chat
    const chatSettingsModal = document.getElementById('chatSettingsModal');
    const chatSettingsBackBtn = document.getElementById('chatSettingsBackBtn');
    const chatThemeList = document.getElementById('chatThemeList');
    
    // Elemen Display Avatar (Container)
    const mainAvatarDisplay = document.getElementById('mainAvatarDisplay');
    const postAvatarDisplay = document.getElementById('postAvatarDisplay');
    const menuAvatarDisplay = document.getElementById('menuAvatarDisplay');
    const settingsAvatarDisplay = document.getElementById('settingsAvatarDisplay');
    
    
    // --- Inisialisasi Awal ---
    // Muat tema chat yang tersimpan
    const savedTheme = localStorage.getItem('chatTheme');
    if (savedTheme) {
        selectedChatThemeId = savedTheme;
    }


    // --- Fungsi Navigasi Halaman ---
    function navigateTo(page) {
      currentPage = page;
      authView.style.display = 'none';
      mainView.style.display = 'none';
      postView.style.display = 'none';
      locationModal.style.display = 'none'; 
      feelingModal.style.display = 'none'; 
      chatView.style.display = 'none';
      menuView.style.display = 'none'; 
      settingsView.style.display = 'none'; 
      avatarModal.style.display = 'none'; 
      chatSettingsModal.style.display = 'none'; 

      if (page === 'Auth') {
        authView.style.display = 'block';
      } else if (page === 'Main') {
        mainView.style.display = 'block';
      } else if (page === 'Post') {
        postView.style.display = 'flex';
        renderLocationBar(); 
        renderPostHeader();
        applyPostViewBackground(); 
      } else if (page === 'Chat') { 
        chatView.style.display = 'flex';
        applyChatTheme(); // Terapkan tema saat buka chat
      } else if (page === 'Menu') { 
        menuView.style.display = 'flex';
      } else if (page === 'Settings') { 
        settingsView.style.display = 'flex';
      } else if (page === 'Avatar') { 
        avatarModal.style.display = 'flex';
      } else if (page === 'ChatSettings') { 
        chatSettingsModal.style.display = 'flex';
      }
    }

    // --- EVENT LISTENERS UI ---
    
    openMenuBtn.addEventListener('click', () => navigateTo('Menu')); 
    
    document.getElementById('goToPostBtn').addEventListener('click', () => {
        selectedLocation = null;
        selectedFeeling = null;
        selectedBackground = null; 
        navigateTo('Post');
    });
    postFormBackBtn.addEventListener('click', () => {
        selectedBackground = null;
        applyPostViewBackground();
        navigateTo('Main');
    });
    document.getElementById('authSwitchToRegister').addEventListener('click', () => {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('registerCard').style.display = 'block';
    });
    document.getElementById('authSwitchToLogin').addEventListener('click', () => {
      document.getElementById('registerCard').style.display = 'none';
      document.getElementById('loginCard').style.display = 'block';
    });

    // Navigasi Chat
    goToChatBtn.addEventListener('click', () => navigateTo('Chat'));
    chatBackBtn.addEventListener('click', () => navigateTo('Main'));
    chatSettingsBtn.addEventListener('click', () => navigateTo('ChatSettings'));
    chatSettingsBackBtn.addEventListener('click', () => navigateTo('Chat'));
    
    // Navigasi Menu & Pengaturan
    menuBackBtn.addEventListener('click', () => navigateTo('Main'));
    menuSettingsBtn.addEventListener('click', () => navigateTo('Settings'));
    menuLogoutBtn.addEventListener('click', () => signOut(auth)); 
    settingsBackBtn.addEventListener('click', () => navigateTo('Menu'));

    // Navigasi Avatar
    openAvatarModalBtn.addEventListener('click', () => navigateTo('Avatar'));
    avatarModalBackBtn.addEventListener('click', () => navigateTo('Settings'));


    // --- Event Listener Lokasi ---
    document.getElementById('openLocationModalBtn').addEventListener('click', () => {
      renderLocationList(DUMMY_LOCATIONS);
      locationModal.style.display = 'flex';
    });
    document.getElementById('locationModalBackBtn').addEventListener('click', () => {
      locationModal.style.display = 'none';
    });
    document.getElementById('removeLocationBtn').addEventListener('click', () => {
      selectedLocation = null;
      renderLocationBar();
    });
    locationSearchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = DUMMY_LOCATIONS.filter(loc => 
        loc.name.toLowerCase().includes(searchTerm) || 
        loc.detail.toLowerCase().includes(searchTerm)
      );
      renderLocationList(filtered);
    });
    
    // --- Event Listener Perasaan ---
    document.getElementById('openFeelingModalBtn').addEventListener('click', () => {
      renderFeelingList(DUMMY_FEELINGS, 'feeling'); 
      feelingTabPerasaan.classList.add('active');
      feelingTabAktivitas.classList.remove('active');
      feelingSearchInput.value = '';
      feelingModal.style.display = 'flex';
    });
    document.getElementById('feelingModalBackBtn').addEventListener('click', () => {
      feelingModal.style.display = 'none';
    });
    feelingTabPerasaan.addEventListener('click', () => {
        renderFeelingList(DUMMY_FEELINGS, 'feeling');
        feelingTabPerasaan.classList.add('active');
        feelingTabAktivitas.classList.remove('active');
    });
    feelingTabAktivitas.addEventListener('click', () => {
        renderFeelingList(DUMMY_ACTIVITIES, 'activity');
        feelingTabPerasaan.classList.remove('active');
        feelingTabAktivitas.classList.add('active');
    });
    feelingSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const currentType = feelingTabPerasaan.classList.contains('active') ? 'feeling' : 'activity';
        const sourceData = currentType === 'feeling' ? DUMMY_FEELINGS : DUMMY_ACTIVITIES;
        const filtered = sourceData.filter(item => 
            item.text.toLowerCase().includes(searchTerm)
        );
        renderFeelingList(filtered, currentType);
    });


    // --- Fungsi Render dan Logika Lokasi ---
    function renderLocationBar() {
      if (selectedLocation) {
        locationBarText.textContent = selectedLocation.name;
        locationSelectionBar.classList.remove('hidden');
      } else {
        locationSelectionBar.classList.add('hidden');
      }
    }
    function renderLocationList(locations) {
      locationList.innerHTML = '';
      if (locations.length === 0) {
        locationList.innerHTML = `<p class="text-center text-gray-500 mt-4">Tidak ada lokasi ditemukan.</p>`;
        return;
      }
      locations.forEach(loc => {
        const item = document.createElement('div');
        item.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100';
        item.innerHTML = `
          <svg class="w-6 h-6 mr-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          <div>
            <p class="font-semibold text-gray-900">${escapeHtml(loc.name)}</p>
            <p class="text-sm text-gray-500">${escapeHtml(loc.detail)}</p>
          </div>
        `;
        item.addEventListener('click', () => {
          selectedLocation = loc;
          locationModal.style.display = 'none';
          navigateTo('Post'); 
        });
        locationList.appendChild(item);
      });
    }

    // --- Fungsi Render Perasaan ---
    function renderPostHeader() {
        const user = auth.currentUser;
        if (!user) return;
        const name = user.displayName || user.email;
        // Avatar diurus oleh updateProfileUI
        let feelingHTML = '';
        if (selectedFeeling) {
            const actionText = selectedFeeling.type === 'feeling' ? 'merasa' : 'sedang';
            feelingHTML = ` ${escapeHtml(selectedFeeling.emoji)} <span class="font-normal">${actionText} ${escapeHtml(selectedFeeling.text)}.</span>`;
        }
        postUsernameText.innerHTML = `${escapeHtml(name)}${feelingHTML}`;
    }
    function renderFeelingList(items, type) {
        feelingList.innerHTML = '';
        if (items.length === 0) {
            feelingList.innerHTML = `<p class="text-center text-gray-500 mt-4">Tidak ada ${type} ditemukan.</p>`;
            return;
        }
        items.forEach(itemData => {
            const item = document.createElement('div');
            item.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100';
            item.innerHTML = `
                <span class="text-2xl mr-3">${itemData.emoji}</span>
                <div>
                    <p class="font-semibold text-gray-900">${escapeHtml(itemData.text)}</p>
                </div>
            `;
            item.addEventListener('click', () => {
                selectedFeeling = { type: type, ...itemData };
                feelingModal.style.display = 'none';
                navigateTo('Post'); 
            });
            feelingList.appendChild(item);
        });
    }

    // --- Fungsi Render & Logika Background ---
    
    function applyPostViewBackground() {
        const postBody = curhatForm.parentElement; // Div flex-grow
        const textarea = curhatForm.text;
        const form = curhatForm; 
        
        const bg = selectedBackground || DUMMY_BACKGROUNDS[0]; 
        
        DUMMY_BACKGROUNDS.forEach(b => {
            postBody.classList.remove(...b.css.split(' '));
            textarea.classList.remove(...b.css.split(' '));
            textarea.classList.remove(...b.textStyle.split(' '));
        });
        textarea.classList.remove('text-center', 'text-left', 'with-background', 'bg-transparent', 'flex-grow');
        postBody.classList.remove('bg-white', 'p-4', 'flex', 'items-center', 'justify-center');
        form.classList.remove('flex-grow', 'flex-col'); 
        
        if (bg.id === 'default') {
            postUserAvatarBlock.classList.remove('hidden');
            postBody.classList.add('bg-white'); 
            form.classList.add('flex-grow', 'flex-col'); 
            textarea.classList.add(...bg.textStyle.split(' '), 'text-left');
            textarea.classList.add('flex-grow'); 
            textarea.placeholder = 'Apa yang Anda pikirkan?';
        } else {
            postUserAvatarBlock.classList.add('hidden');
            postBody.classList.add(...bg.css.split(' '), 'flex', 'items-center', 'justify-center');
            textarea.classList.add(...bg.textStyle.split(' '), 'text-center', 'with-background', 'bg-transparent');
            textarea.placeholder = 'Mulai mengetik...';
        }
    }

    function renderBackgroundSelector() {
        backgroundSelectorContainer.innerHTML = '';
        DUMMY_BACKGROUNDS.forEach(bg => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'w-10 h-16 rounded-lg shrink-0 cursor-pointer border-2 border-gray-300 hover:border-fb-blue focus:border-fb-blue';
            
            item.classList.add(...bg.css.split(' '));

            if (bg.id === 'default') {
                item.innerHTML = `<span class="font-bold text-xl text-gray-700">A</span>`;
                item.classList.add('flex', 'items-center', 'justify-center');
            }
            
            item.addEventListener('click', () => {
                selectedBackground = bg;
                applyPostViewBackground();
            });
            backgroundSelectorContainer.appendChild(item);
        });
    }
    
    // --- Fungsi Render & Logika Avatar ---
    function renderAvatarList() {
        avatarList.innerHTML = '';
        DUMMY_AVATARS.forEach(avatar => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'aspect-square bg-gray-200 rounded-full flex items-center justify-center text-gray-700 hover:bg-gray-300 focus:ring-2 focus:ring-fb-blue';
            item.innerHTML = avatar.svg.replace('avatar-icon', 'avatar-icon-lg');
            
            item.addEventListener('click', () => {
                selectAvatar(avatar.id);
            });
            avatarList.appendChild(item);
        });
    }
    
    async function selectAvatar(avatarId) {
        const user = auth.currentUser;
        if (!user) return showModalMessage("Kesalahan", "Anda harus login.");
        try {
            await setDoc(doc(db, "users", user.uid), { avatarId: avatarId }, { merge: true });
            navigateTo('Settings'); // Kembali ke pengaturan
        } catch (err) {
            console.error("Gagal simpan avatar:", err);
            showModalMessage("Gagal Simpan", "Gagal menyimpan avatar Anda.");
        }
    }
    
    // --- Fungsi Render & Logika Tema Chat ---
    function applyChatTheme() {
        // Hapus semua tema lama
        DUMMY_CHAT_THEMES.forEach(theme => {
            chatMessageList.classList.remove(...theme.css.split(' '));
        });
        
        // Tambahkan tema baru
        const theme = DUMMY_CHAT_THEMES.find(t => t.id === selectedChatThemeId) || DUMMY_CHAT_THEMES[0];
        chatMessageList.classList.add(...theme.css.split(' '));
    }
    
    function renderChatThemeSelector() {
        chatThemeList.innerHTML = '';
        DUMMY_CHAT_THEMES.forEach(theme => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'flex flex-col items-center gap-2 hover:opacity-80';
            
            item.innerHTML = `
                <div class="w-16 h-16 rounded-full ${theme.css} border-2 border-gray-300"></div>
                <p class="font-semibold text-sm">${escapeHtml(theme.name)}</p>
            `;
            
            item.addEventListener('click', () => {
                selectedChatThemeId = theme.id;
                localStorage.setItem('chatTheme', theme.id); // Simpan ke localStorage
                applyChatTheme();
                
                // Update UI tombol
                document.querySelectorAll('#chatThemeList button').forEach(btn => btn.classList.remove('ring-2', 'ring-fb-blue', 'ring-offset-2'));
                item.classList.add('ring-2', 'ring-fb-blue', 'ring-offset-2');
            });
            
            if (theme.id === selectedChatThemeId) {
                item.classList.add('ring-2', 'ring-fb-blue', 'ring-offset-2');
            }
            
            chatThemeList.appendChild(item);
        });
    }


    // --- Bagian Auth, Profile ---
    
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        registerForm.reset();
      } catch (err) {
        console.error("Gagal daftar:", err);
        showModalMessage("Gagal daftar", err.message);
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target.email.value;
      const pass = e.target.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        loginForm.reset();
      } catch (err) {
        console.error("Gagal login:", err);
        showModalMessage("Gagal masuk", err.message);
      }
    });

    function updateProfileUI(user, userData = {}) {
        if (!user) return;
        
        const displayName = user.displayName || user.email;
        const avatarId = userData.avatarId || null;
        currentUserAvatarId = avatarId; 
        
        const avatarLetter = displayName[0] ? displayName[0].toUpperCase() : '?';
        const avatarData = DUMMY_AVATARS.find(a => a.id === avatarId);
        
        const innerHtml = avatarData ? avatarData.svg : avatarLetter;
        const baseClasses = "rounded-full flex items-center justify-center font-bold";
        const colorClasses = avatarData ? "bg-gray-200 text-gray-700" : "bg-fb-blue text-white";

        // 1. Main View (Header)
        userStatusDisplay.textContent = displayName; 
        mainAvatarDisplay.innerHTML = innerHtml;
        mainAvatarDisplay.className = `w-10 h-10 ${baseClasses} ${colorClasses} text-lg`;
        
        // 2. Post View
        postAvatarDisplay.innerHTML = innerHtml;
        postAvatarDisplay.className = `w-12 h-12 ${baseClasses} ${colorClasses} text-xl mr-3`;
        renderPostHeader(); // Update nama + feeling
        
        // 3. Menu View
        menuProfileName.textContent = displayName;
        menuAvatarDisplay.innerHTML = innerHtml;
        menuAvatarDisplay.className = `w-12 h-12 ${baseClasses} ${colorClasses} text-xl mr-4`;
        
        // 4. Settings View
        settingsProfileName.textContent = displayName;
        settingsAvatarDisplay.innerHTML = innerHtml;
        settingsAvatarDisplay.className = `w-24 h-24 ${baseClasses} ${colorClasses} text-4xl mb-4`;
        settingsNameInput.value = displayName;
        
        // 5. Update semua avatar di kolom komentar
        const commentAvatars = document.querySelectorAll('.currentUserCommentAvatar');
        commentAvatars.forEach(avatarEl => {
            avatarEl.innerHTML = innerHtml;
            avatarEl.className = `w-8 h-8 ${baseClasses} ${colorClasses} text-sm currentUserCommentAvatar`;
        });
    }

    async function saveProfileName(name) {
      const user = auth.currentUser;
      if (!user) return;
      await updateProfile(user, { displayName: name });
      await setDoc(doc(db, "users", user.uid), {
        name,
        email: user.email,
        updatedAt: new Date()
      }, { merge: true }); 
    }

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = profileNameInput.value.trim();
      if (!name) return showModalMessage("Perhatian", "Nama tidak boleh kosong");
      try {
        await saveProfileName(name);
        profileModal.style.display = "none";
        navigateTo('Main');
      } catch (err) {
        console.error("Gagal simpan nama:", err);
        showModalMessage("Gagal simpan nama", err.message);
      }
    });
    
    settingsForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = settingsNameInput.value.trim();
        if (!name) return showModalMessage("Perhatian", "Nama tidak boleh kosong");
        
        try {
            await saveProfileName(name);
            showModalMessage("Sukses", "Nama berhasil diperbarui!");
            navigateTo('Menu'); 
        } catch (err) {
            console.error("Gagal simpan nama:", err);
            showModalMessage("Gagal simpan nama", err.message);
        }
    });

    function subscribeToUserDoc(uid) {
        if (userDocUnsubscribe) userDocUnsubscribe(); 
        
        userDocUnsubscribe = onSnapshot(doc(db, "users", uid), (docSnap) => {
            const user = auth.currentUser;
            if (user) {
                if (docSnap.exists()) {
                    updateProfileUI(user, docSnap.data());
                } else {
                    updateProfileUI(user, {}); 
                }
            }
        }, (err) => {
            console.error("Gagal listen ke user doc:", err);
        });
    }


    let unsubscribeCurhatListener = null;
    let unsubscribeChatListener = null; 

    onAuthStateChanged(auth, async (user) => {
      if (unsubscribeCurhatListener) unsubscribeCurhatListener();
      if (unsubscribeChatListener) unsubscribeChatListener();
      if (userDocUnsubscribe) userDocUnsubscribe(); 

      if (user) {
        if (!user.displayName) {
          profileModal.style.display = "flex";
          navigateTo('Auth'); 
          return;
        }

        subscribeToUserDoc(user.uid); 
        
        profileModal.style.display = "none";
        navigateTo('Main');

        unsubscribeCurhatListener = listenCurhatan();
        unsubscribeChatListener = listenGlobalChat();
        
        renderBackgroundSelector(); 
        renderAvatarList(); 
        renderChatThemeSelector(); // Siapkan modal tema chat
      } else {
        userStatusDisplay.textContent = "Guest";
        navigateTo('Auth');
      }
    });

    // --- POST CURHATAN (Firestore) ---
    curhatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = e.target.text.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) return showModalMessage("Kesalahan", "Harus login dulu");
      const userName = user.displayName || user.email;
      const postData = {
        text, userId: user.uid, userName, createdAt: new Date(), comments: []
      };
      if (currentUserAvatarId) {
          postData.userAvatarId = currentUserAvatarId;
      }
      if (selectedLocation) { postData.location = selectedLocation; }
      if (selectedFeeling) { postData.feeling = selectedFeeling; }
      if (selectedBackground && selectedBackground.id !== 'default') {
          postData.background = selectedBackground;
      }

      try {
        await addDoc(collection(db, "curhatan"), postData);
        curhatForm.reset();
        selectedLocation = null; 
        selectedFeeling = null;
        selectedBackground = null; 
        applyPostViewBackground(); 
        navigateTo('Main'); 
      } catch (err) {
        console.error("Gagal posting:", err);
        showModalMessage("Gagal posting", err.message);
      }
    });

    // --- KIRIM PESAN CHAT GLOBAL (Firestore) ---
    chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = chatTextInput.value.trim();
        if (!text) return;
        const user = auth.currentUser;
        if (!user) return showModalMessage("Kesalahan", "Harus login dulu");
        const userName = user.displayName || user.email;
        const messageData = {
            text, userId: user.uid, userName, createdAt: new Date()
        };
        try {
            await addDoc(collection(db, "globalChat"), messageData);
            chatForm.reset();
            chatMessageList.scrollTop = chatMessageList.scrollHeight;
        } catch (err) {
            console.error("Gagal kirim pesan:", err);
            showModalMessage("Gagal kirim pesan", err.message);
        }
    });


    // --- LISTEN REAL-TIME CURHATAN ---
    function listenCurhatan() {
      const q = query(collection(db, "curhatan"), orderBy("createdAt", "desc"));
      const unsub = onSnapshot(q, (snapshot) => {
        curhatList.innerHTML = "";
        
        if (snapshot.empty) {
             curhatList.innerHTML = `
                <p class="text-center text-gray-500 mt-10 mb-4">Belum ada curhatan. Ayo buat postingan pertamamu!</p>
                ${generateDummyPosts()}
            `;
            curhatList.classList.add('pb-10');
            return;
        } else {
            curhatList.classList.remove('pb-10');
        }

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const id = docSnap.id;
          const displayName = data.userName || data.user || "Anon";
          const time = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }) : 'Baru saja';
          const isOwnPost = auth.currentUser && data.userId === auth.currentUser.uid;
          
          const backgroundData = data.background;
          const locationData = data.location;
          const feelingData = data.feeling;
          const postAvatarId = data.userAvatarId; 
          
          let feelingDisplay = '';
          if (feelingData) {
              const actionText = feelingData.type === 'feeling' ? 'merasa' : 'sedang';
              feelingDisplay = ` ${escapeHtml(feelingData.emoji || '')} <span class="font-normal">${actionText} ${escapeHtml(feelingData.text)}.</span>`;
          }
          
          const mapPlaceholder = (!backgroundData && locationData) 
              ? `<div class="bg-gray-100 mt-3 rounded-lg overflow-hidden relative">...</div>` : '';
            
          const div = document.createElement("div");
          div.className = `post-card mb-3 shadow-md`; 
          
          const avatarData = DUMMY_AVATARS.find(a => a.id === postAvatarId);
          const avatarInnerHtml = avatarData ? avatarData.svg : displayName[0].toUpperCase();
          const avatarClasses = avatarData ? "bg-gray-200 text-gray-700" : "bg-fb-blue text-white";
          
          const userInfoHtml = `
            <div class="p-4">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg mr-2 ${avatarClasses}">
                        ${avatarInnerHtml}
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-900">
                            ${escapeHtml(displayName)} 
                            ${feelingDisplay}
                            ${!backgroundData && locationData ? ` di <a href="#" class="font-bold text-fb-blue hover:underline">${escapeHtml(locationData.name)}</a>` : ''}
                        </p>
                        <p class="text-xs text-gray-500">${time} ¬∑ Publik</p>
                    </div>
                    ${isOwnPost ? `<div class="text-xs text-fb-blue">Anda</div>` : ''}
                </div>
            </div>
          `;
          
          const postContentHtml = backgroundData ?
            `<div class="${backgroundData.css} ${backgroundData.textStyle} aspect-video flex items-center justify-center p-6 text-center whitespace-pre-wrap mx-4 rounded-lg">
                ${escapeHtml(data.text)}
            </div>`
            :
            `<div class="px-4">
                <p class="text-gray-800 text-lg my-3 whitespace-pre-wrap">${escapeHtml(data.text)}</p>
                ${mapPlaceholder}
            </div>`;
          
          const buttonsHtml = `
            <div class="p-4 pt-0">
                <div class="flex justify-around border-t border-gray-200 mt-4 pt-2">
                    <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                        <svg classs="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v5M6 10h2l3 3m-3 0v7a1 1 0 01-1 1H4a1 1 0 01-1-1v-7a1 1 0 011-1h2z"></path></svg>
                        Suka
                    </button>
                    <button class="comment-toggle flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 01-4.735-1.248l-3.376 1.099A.999.999 0 013 18.5V12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Komentar (${(data.comments || []).length})
                    </button>
                    <button class="flex items-center text-gray-600 hover:text-fb-blue transition duration-150 p-2 rounded-lg">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.024-3.535a6.66 6.66 0 000-4.634l-6.024-3.535M18 12a3 3 0 110-6 3 3 0 010 6zm0 0a3 3 0 110-6 3 3 0 010 6z"></path></svg>
                        Bagikan
                    </button>
                </div>
            </div>
          `;
          
          const user = auth.currentUser;
          const userAvatarData = DUMMY_AVATARS.find(a => a.id === currentUserAvatarId);
          const userAvatarInnerHtml = userAvatarData ? userAvatarData.svg : (user ? user.displayName[0].toUpperCase() : 'A');
          const userAvatarClasses = userAvatarData ? "bg-gray-200 text-gray-700" : "bg-fb-blue text-white";

          const commentsHtml = `
            <div class="comments-area border-t border-gray-100 p-4 bg-gray-50 hidden">
                <div class="comments space-y-3 mb-4">
                  ${(data.comments || []).map(c => {
                    const commenterAvatarData = DUMMY_AVATARS.find(a => a.id === c.userAvatarId);
                    const commenterAvatarHtml = commenterAvatarData ? commenterAvatarData.svg : (c.userName ? c.userName[0].toUpperCase() : 'A');
                    const commenterAvatarClasses = commenterAvatarData ? "bg-gray-200 text-gray-700" : "bg-gray-300";
                    
                    return `
                    <div class="flex items-start">
                        <div class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold mr-2 ${commenterAvatarClasses} shrink-0">
                           ${commenterAvatarHtml.replace('avatar-icon', 'avatar-icon-sm')}
                        </div>
                        <div class="bg-gray-200 p-2 rounded-xl flex-grow max-w-[calc(100%-40px)]">
                            <p class="font-semibold text-sm text-gray-800">${escapeHtml(c.userName || c.user)}</p>
                            <p class="text-sm text-gray-700 break-words">${escapeHtml(c.text)}</p>
                        </div>
                    </div>
                  `}).join("")}
                </div>
                <form class="commentForm flex gap-2 items-center">
                    <div class="currentUserCommentAvatar w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${userAvatarClasses}">
                        ${userAvatarInnerHtml}
                    </div>
                    <input type="text" placeholder="Tulis komentar..." required
                        class="flex-grow px-3 py-2 text-sm border-gray-300 bg-white rounded-full focus:ring-0 focus:border-fb-blue"
                    >
                    <button class="text-fb-blue hover:opacity-75 transition duration-150 p-2 rounded-full">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m8 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </form>
            </div>
          `;
          
          div.innerHTML = userInfoHtml + postContentHtml + buttonsHtml + commentsHtml;
            
          const commentToggleBtn = div.querySelector(".comment-toggle");
          const commentsArea = div.querySelector(".comments-area");
          commentToggleBtn.addEventListener('click', () => {
            commentsArea.classList.toggle('hidden');
          });
          
          const form = div.querySelector(".commentForm");
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const commentInput = e.target.querySelector('input[type="text"]');
            const commentText = commentInput.value.trim();
            if (!commentText) return;
            const user = auth.currentUser;
            if (!user) return showModalMessage("Kesalahan", "Harus login dulu untuk berkomentar!");
            
            const commentData = {
                userId: user.uid,
                userName: user.displayName || user.email,
                text: commentText,
                createdAt: new Date()
            };
            if (currentUserAvatarId) {
                commentData.userAvatarId = currentUserAvatarId;
            }
            
            try {
              await updateDoc(doc(db, "curhatan", id), {
                comments: arrayUnion(commentData)
              });
              e.target.reset();
            } catch (err) {
              console.error("Gagal kirim komentar:", err);
              showModalMessage("Gagal kirim komentar", err.message);
            }
          });
          curhatList.appendChild(div);
        });
      }, (err) => {
        console.error("Listen curhatan error:", err);
      });
      return unsub;
    }

    // --- LISTEN REAL-TIME CHAT GLOBAL ---
    function listenGlobalChat() {
        const q = query(collection(db, "globalChat"), orderBy("createdAt", "asc"), limitToLast(50));
        const unsub = onSnapshot(q, (snapshot) => {
            chatMessageList.innerHTML = ""; 
            if (snapshot.empty) {
                chatMessageList.innerHTML = `<p class="text-center text-gray-500 mt-4">Belum ada pesan. Mulai obrolan!</p>`;
                return;
            }
            snapshot.forEach((doc) => {
                const data = doc.data();
                const isOwnMessage = auth.currentUser && data.userId === auth.currentUser.uid;
                const container = document.createElement('div');
                container.className = 'chat-message-container';
                if (isOwnMessage) {
                    container.classList.add('sent');
                    container.innerHTML = `<div class="chat-bubble sent">${escapeHtml(data.text)}</div>`;
                } else {
                    container.classList.add('received');
                    container.innerHTML = `
                        <p class="chat-sender-name">${escapeHtml(data.userName)}</p>
                        <div class="chat-bubble received">${escapeHtml(data.text)}</div>
                    `;
                }
                chatMessageList.appendChild(container);
            });
            chatMessageList.scrollTop = chatMessageList.scrollHeight;
        }, (err) => {
            console.error("Listen chat error:", err);
        });
        return unsub;
    }


    // --- Helper: Generate Dummy Posts ---
    function generateDummyPosts() {
        const dummyData = [
            { name: "Sistem", text: "Curhatanmu akan muncul di sini. Coba buat postingan pertamamu!", time: "Sekarang", location: { name: "Jeneponto", detail: "Sulawesi Selatan" } },
            { name: "Admin", text: "Ini adalah postingan dummy untuk memastikan tampilan feed terlihat penuh.", time: "2 hari lalu", feeling: { emoji: 'üòä', text: 'senang', type: 'feeling'}, userAvatarId: 'ghost' },
            { name: "Contoh BG", text: "Ini contoh postingan dengan background!", time: "3 hari lalu", background: DUMMY_BACKGROUNDS[1], userAvatarId: 'fire' }
        ];
        return dummyData.map(data => {
            const backgroundData = data.background;
            const locationDisplay = (!backgroundData && data.location)
              ? ` di <a href="#" class="font-bold text-fb-blue hover:underline">${data.location.name}</a>` : '';
            let feelingDisplay = '';
            if (data.feeling) {
                const actionText = data.feeling.type === 'feeling' ? 'merasa' : 'sedang';
                feelingDisplay = ` ${escapeHtml(data.feeling.emoji || '')} <span class="font-normal">${actionText} ${escapeHtml(data.feeling.text)}.</span>`;
            }
            
            const avatarData = DUMMY_AVATARS.find(a => a.id === data.userAvatarId);
            const avatarInnerHtml = avatarData ? avatarData.svg : data.name[0].toUpperCase();
            const avatarClasses = avatarData ? "bg-gray-200 text-gray-700" : "bg-gray-400 text-white";

            const userInfoHtml = `
              <div class="p-4">
                  <div class="flex items-center mb-3">
                      <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg mr-2 ${avatarClasses}">
                          ${avatarInnerHtml}
                      </div>
                      <div class="flex-grow">
                          <p class="font-semibold text-gray-900">${data.name} ${feelingDisplay} ${locationDisplay}</p>
                          <p class="text-xs text-gray-500">${data.time} ¬∑ Dummy</p>
                      </div>
                  </div>
              </div>
            `;
            const postContentHtml = backgroundData ?
              `<div class="${backgroundData.css} ${backgroundData.textStyle} aspect-video flex items-center justify-center p-6 text-center whitespace-pre-wrap mx-4 rounded-lg">
                  ${escapeHtml(data.text)}
              </div>`
              :
              `<div class="px-4">
                  <p class="text-gray-800 text-lg my-3 whitespace-pre-wrap">${escapeHtml(data.text)}</p>
              </div>`;
            
            const buttonsHtml = `
              <div class="p-4 pt-0">
                  <div class="flex justify-around border-t border-gray-200 mt-4 pt-2 text-gray-400">
                      <button class="p-2">Suka</button>
                      <button class="p-2">Komentar</button>
                      <button class="p-2">Bagikan</button>
                  </div>
              </div>
            `;
            return `<div class="post-card mb-3 shadow-md opacity-80">${userInfoHtml}${postContentHtml}${buttonsHtml}</div>`;
        }).join("");
    }

    // --- Helper: escape untuk mencegah XSS sederhana ---
    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- Helper: Modal Pesan (Mengganti alert()) ---
    const msgModal = document.getElementById('messageModal');
    const msgTitle = document.getElementById('messageTitle');
    const msgContent = document.getElementById('messageContent');
    document.getElementById('messageCloseBtn').addEventListener('click', () => msgModal.style.display = 'none');
    
    function showModalMessage(title, content) {
        msgTitle.textContent = title;
        msgContent.textContent = content;
        msgModal.style.display = 'flex';
    }

  </script>
</head>

<body>
  
  

<div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[5000]">
      <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-xs text-center">
          <h4 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">Pesan</h4>
          <p id="messageContent" class="text-gray-700 mb-4"></p>
          <button id="messageCloseBtn" class="bg-fb-blue hover:bg-opacity-80 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">Tutup</button>
      </div>
  </div>

  

<div id="profileModal" class="hidden">
    <div class="box bg-white p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
      <h3 class="text-2xl font-extrabold text-fb-blue mb-2">Selamat datang! üëã</h3>
      <p class="text-gray-600 mb-6">Tolong isi nama profil yang ingin kamu gunakan.</p>
      <form id="profileForm" class="space-y-4">
        <input id="profileName" type="text" placeholder="Nama yang mau ditampilkan" required 
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fb-blue focus:border-fb-blue"
        />
        <button type="submit" class="w-full bg-fb-blue hover:bg-opacity-80 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
          Simpan Nama
        </button>
      </form>
    </div>
  </div>


  

<div id="authView" class="hidden min-h-screen flex items-center justify-center bg-white p-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-10">
        <svg class="mx-auto w-16 h-16 text-fb-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" />
        </svg>
      </div>

<div id="loginCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Masuk ke Konexa App</h3>
        <form id="loginForm" class="space-y-4">
          <input type="email" name="email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue">
          <input type="password" name="password" placeholder="Kata Sandi" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue">
          <button class="w-full bg-fb-blue hover:bg-opacity-90 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
            Login
          </button>
        </form>
        <p class="text-center mt-4 text-sm"><a href="#" class="text-fb-blue hover:underline">Lupa kata sandi?</a></p>
        <div class="border-t border-gray-200 my-6"></div>
        <button id="authSwitchToRegister" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150">
          Buat Akun Baru
        </button>
      </div>
<div id="registerCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hidden">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Daftar Akun Baru</h3>
        <form id="registerForm" class="space-y-4">
          <input type="email" name="email" placeholder="Email baru" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue">
          <input type="password" name="password" placeholder="Password baru" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-fb-blue">
          <button class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
            Daftar
          </button>
        </form>
        <p class="text-center mt-4 text-sm">
            Sudah punya akun? <a href="#" id="authSwitchToLogin" class="text-fb-blue hover:underline">Login di sini</a>
        </p>
      </div>
    </div>
  </div>


  

<div id="mainView" class="hidden pt-24 min-h-screen"> 
    
<nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-10">
      <div class="flex items-center justify-between max-w-xl mx-auto p-3">
        <h1 class="text-2xl font-extrabold text-fb-blue">Konexa App</h1>
        <div class="flex items-center space-x-3">
            <button id="openMenuBtn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition duration-150">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
            </button>
        </div>
      </div>
      
      <div class="flex justify-around border-t border-gray-200 text-gray-500">
        <div class="p-3 text-fb-blue border-b-2 border-fb-blue font-semibold w-full text-center">Feed Curhat</div>
        <button id="goToChatBtn" class="p-3 hover:bg-gray-100 transition duration-150 w-full text-center">Pesan Global</button>
      </div>
    </nav>

<div class="max-w-xl mx-auto px-3 pt-3 pb-10"> 
        
<div class="bg-white p-3 rounded-xl shadow-md mb-4 border border-gray-100">
            <div class="flex items-center space-x-2">
                <div id="mainAvatarDisplay" class="w-10 h-10 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-lg">
                    <span>?</span>
                </div>
                <button id="goToPostBtn" class="flex-grow text-left bg-fb-gray p-2.5 rounded-full text-gray-600 hover:bg-gray-200 transition duration-150">
                    Apa yang Anda pikirkan? (<span id="userStatusDisplay">...</span>)
                </button>
            </div>
            <div class="border-t border-gray-200 mt-3 pt-3 flex justify-around">
                <div class="flex items-center text-red-500 font-medium">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Foto/Video
                </div>
                <div class="flex items-center text-green-500 font-medium">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Perasaan
                </div>
            </div>
        </div>
<div id="curhatList">
          <p class="text-center text-gray-500 mt-10">Memuat curhatan...</p>
        </div>
    </div>
  </div>


  

<div id="postView" class="hidden fixed inset-0 flex flex-col bg-white z-20">
    
<header class="modal-header flex items-center justify-between p-4 border-b border-gray-200 shadow-sm">
        <button id="postFormBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        </button>
        <h2 class="text-xl font-bold text-gray-900">Buat Curhatan</h2>
        <button id="submitPostBtn" form="curhatForm" class="bg-fb-blue hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 disabled:bg-gray-400">
            POSTING
        </button>
    </header>

    
<div class="flex-grow overflow-y-auto bg-white"> 
        <div id="postUserAvatarBlock" class="flex items-center mb-6 p-4 pb-0">
            <div id="postAvatarDisplay" class="w-12 h-12 rounded-full bg-fb-blue flex items-center justify-center text-white font-bold text-xl mr-3">
                <span id="postAvatarLetter">?</span>
            </div>
            <div>
                <p class="font-semibold text-gray-900 text-lg">
                    <span id="postUsernameText">Pengguna</span>
                </p>
                <div class="flex items-center text-sm text-gray-600 bg-gray-200 rounded-full px-3 py-1 mt-1">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0v4m-6 4h2m-2 4h2m6-4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-4a3 3 0 013-3h2.586a1 1 0 01.707.293l1.414 1.414A1 1 0 0012.414 14H18a2 2 0 002-2v-4a2 2 0 00-2-2h-3.586a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 009.586 6H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2v-1"></path></svg>
                    Publik
                </div>
            </div>
        </div>

        <form id="curhatForm" class="flex flex-col">
            <textarea name="text" rows="10" placeholder="Apa yang Anda pikirkan?" required
              class="p-4 pt-0 border-none resize-none focus:ring-0 focus:border-transparent"
            ></textarea> 
        </form>
        
    </div>

    

<div id="locationSelectionBar" class="hidden absolute bottom-20 left-4 right-4 bg-white p-3 rounded-xl shadow-lg border border-gray-200 flex items-center justify-between">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span id="locationBarText" class="font-semibold text-gray-800">Nama Lokasi</span>
        </div>
        <button id="removeLocationBtn" class="text-gray-500 hover:text-gray-700 p-1 rounded-full">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    

<div class="border-t border-gray-200 bg-white">
    <div id="backgroundSelectorContainer" class="flex items-center space-x-2 p-3 overflow-x-auto">
        </div>
    <div class="p-4 border-t border-gray-100">
        <div class="space-y-4">
            <div class="flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150">
                <svg class="w-6 h-6 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Foto/Video
            </div>
            
            <button id="openLocationModalBtn" class="w-full flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150 text-left">
                <svg class="w-6 h-6 mr-3 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Tambahkan lokasi
            </button>

            <button id="openFeelingModalBtn" class="w-full flex items-center text-gray-700 font-medium p-2 hover:bg-gray-100 rounded-lg transition duration-150 text-left">
                <svg class="w-6 h-6 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Perasaan/aktivitas
            </button>
        </div>
    </div>
</div>
</div>


  

<div id="locationModal" class="flex-col">
      <header class="modal-header flex items-center justify-between p-4 border-b border-gray-200">
          <button id="locationModalBackBtn" class="text-gray-700 hover:text-gray-900 p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Tambahkan Lokasi Anda</h2>
          <div class="w-6"></div>
      </header>
<div class="p-4 border-b border-gray-200 bg-white">
          <div class="flex items-center bg-gray-100 rounded-full p-2">
              <input id="locationSearchInput" type="text" placeholder="Cari"
                  class="flex-grow bg-transparent border-none focus:ring-0 focus:border-transparent p-0 text-lg"
              />
              <svg class="w-6 h-6 text-gray-500 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
      </div>
<div class="flex-grow overflow-y-auto bg-white">
          <h3 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200">Saran</h3>
          <div id="locationList"></div>
      </div>
  </div>

  

<div id="feelingModal" class="flex-col">
      <header class="modal-header flex items-center justify-between p-4 border-b border-gray-200">
          <button id="feelingModalBackBtn" class="text-gray-700 hover:text-gray-900 p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Apa yang Anda rasakan?</h2>
          <div class="w-6"></div>
      </header>
<div class="flex border-b border-gray-200 bg-white">
          <button id="feelingTabPerasaan" class="feeling-tab flex-1 p-4 font-semibold text-gray-600 border-b-2 border-transparent hover:bg-gray-50 active">
              Perasaan
          </button>
          <button id="feelingTabAktivitas" class="feeling-tab flex-1 p-4 font-semibold text-gray-600 border-b-2 border-transparent hover:bg-gray-50">
              Aktivitas
          </button>
      </div>
<div class="p-4 border-b border-gray-200 bg-white">
          <div class="flex items-center bg-gray-100 rounded-full p-2">
              <input id="feelingSearchInput" type="text" placeholder="Cari..."
                  class="flex-grow bg-transparent border-none focus:ring-0 focus:border-transparent p-0 text-lg"
              />
              <svg class="w-6 h-6 text-gray-500 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
      </div>
<div class="flex-grow overflow-y-auto bg-white">
          <div id="feelingList"></div>
      </div>
  </div>


  

<div id="chatView" class="hidden"> 
      <header class="modal-header flex items-center justify-between p-4 border-b border-gray-200 shadow-sm">
          <button id="chatBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Chat Global (GC)</h2>
          <button id="chatSettingsBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </button>
      </header>

      <div id="chatMessageList" class="flex-grow overflow-y-auto"></div>

      <footer class="p-3 border-t border-gray-200 bg-white">
          <form id="chatForm" class="flex items-center gap-2">
              <input id="chatTextInput" type="text" placeholder="Tulis pesan..." required
                  class="flex-grow px-4 py-2 text-sm border-gray-300 bg-fb-gray rounded-full focus:ring-0 focus:border-fb-blue"
              />
              <button type="submit" class="text-fb-blue hover:opacity-75 transition duration-150 p-2 rounded-full">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
              </button>
          </form>
      </footer>
  </div>


  <div id="menuView" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="menuBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Menu</h2>
          <div class="w-6"></div></header>

      <div class="flex-grow overflow-y-auto p-4">
          <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center">
              <div id="menuAvatarDisplay" class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-xl font-bold text-gray-700 mr-4">
                  ?
              </div>
              <div>
                  <h3 id="menuProfileName" class="text-xl font-bold text-gray-900">Nama Pengguna</h3>
                  <p class="text-sm text-gray-600">Lihat profil Anda</p>
              </div>
          </div>
          
          <button id="menuSettingsBtn" class="w-full flex items-center bg-white p-4 rounded-lg shadow-md mb-4 text-left hover:bg-gray-50 transition duration-150">
              <div class="p-2 bg-gray-200 rounded-full mr-4">
                  <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
              </div>
              <p class="text-lg font-semibold text-gray-800">Pengaturan</an>
          </button>
          
          <button id="menuLogoutBtn" class="w-full flex items-center bg-white p-4 rounded-lg shadow-md text-left hover:bg-gray-50 transition duration-150">
              <div class="p-2 bg-gray-200 rounded-full mr-4">
                  <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
              </div>
              <p class="text-lg font-semibold text-gray-800">Keluar</p>
          </button>
      </div>
  </div>


  <div id="settingsView" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="settingsBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Pengaturan Akun</h2>
          <div class="w-6"></div></header>

      <div class="flex-grow overflow-y-auto p-4">
          <div class="flex flex-col items-center bg-white p-6 rounded-lg shadow-md mb-4">
              <div id="settingsAvatarDisplay" class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-4xl font-bold text-gray-700 mb-4">
                  ?
              </div>
              <h3 id="settingsProfileName" class="text-2xl font-bold text-gray-900">Nama Pengguna</h3>
              <p class="text-sm text-gray-600">Konexa App</p>
          </div>
          
          <button id="openAvatarModalBtn" class="w-full bg-white p-4 rounded-lg shadow-md text-left hover:bg-gray-50 transition duration-150 mb-4 font-semibold text-gray-800">
              Ganti Avatar
          </button>
          
          <form id="settingsForm" class="bg-white p-4 rounded-lg shadow-md">
              <div class="mb-4">
                  <label for="settingsNameInput" class="block text-sm font-medium text-gray-700 mb-2">Nama</label>
                  <input id="settingsNameInput" type="text" required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fb-blue focus:border-fb-blue"
                  />
              </div>
              <button type="submit" class="w-full bg-fb-blue hover:bg-opacity-80 text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
                  Simpan Perubahan
              </button>
          </form>
      </div>
  </div>
  
  
  <div id="avatarModal" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="avatarModalBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Pilih Avatar</h2>
          <div class="w-6"></div>
      </header>

      <div class="flex-grow overflow-y-auto p-4 bg-white">
          <div id="avatarList" class="grid grid-cols-3 gap-4">
              <p class="col-span-3 text-center text-gray-500">Memuat avatar...</p>
          </div>
      </div>
  </div>

  
  <div id="chatSettingsModal" class="hidden"> 
      <header class="modal-header flex items-center p-4 border-b border-gray-200 shadow-sm">
          <button id="chatSettingsBackBtn" class="text-gray-700 hover:text-fb-blue p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900 mx-auto">Pengaturan Chat</h2>
          <div class="w-6"></div>
      </header>

      <div class="flex-grow overflow-y-auto p-4">
          <div class="bg-white p-4 rounded-lg shadow-md mb-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Ganti Tema Chat</h3>
              <div id="chatThemeList" class="grid grid-cols-3 gap-4">
                  <p class="col-span-3 text-center text-gray-500">Memuat tema...</p>
              </div>
          </div>
          
          <div class="bg-white p-4 rounded-lg shadow-md">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Pengaturan Admin</h3>
              <button disabled class="w-full bg-gray-200 p-3 rounded-lg text-left text-gray-500 cursor-not-allowed">
                  Ganti Nama GC
                  <span class="text-xs block font-normal">(Fitur admin, segera hadir)</span>
              </button>
          </div>
      </div>
  </div>

</body>
</html>